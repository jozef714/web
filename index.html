<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gesti√≥n Ganadera</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üêÑ</text></svg>">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div id="login-container">
        <div class="login-box">
            <div class="logo">
                <i class="fas fa-cow"></i>
                <h1>Gesti√≥n Ganadera</h1>
            </div>
            <h2>Iniciar Sesi√≥n</h2>
            <form id="login-form">
                <input type="email" id="email" placeholder="Correo electr√≥nico" required>
                <div class="error-message" id="email-error"></div>
                
                <input type="password" id="password" placeholder="Contrase√±a" required minlength="6">
                <div class="error-message" id="password-error"></div>
                
                <button type="submit" id="login-button">
                    <i class="fas fa-sign-in-alt"></i> 
                    <span id="login-button-text">Iniciar Sesi√≥n</span>
                    <i class="fas fa-spinner fa-spin" id="login-spinner" style="display: none;"></i>
                </button>
            </form>
        </div>
    </div>

    <div id="main-app">
        <header>
            <div class="header-left">
                <button id="menuHamburguesa" class="hamburger">‚ò∞</button>
                <div class="header-title">
                    <h1>Sistema de Gesti√≥n Ganadera</h1>
                    <p>Administraci√≥n integral de tu ganado</p>
                </div>
            </div>
            <div class="header-right">
                <button id="btnExportar" class="btn btn-primary"><i class="fas fa-file-excel"></i> Exportar</button>
                <div class="connection-status">
                    <div class="status-dot"></div>
                    <span class="status-text">Conectando...</span>
                </div>
                <div class="user-info">
                    <img id="user-avatar" src="https://ui-avatars.com/api/?name=U&background=3498db&color=fff" alt="Usuario">
                    <button id="btnLogout" class="btn btn-danger"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </header>

        <div id="sidebar" class="sidebar">
            <ul>
                <li><button data-seccion="registro" class="active"><i class="fas fa-plus-circle"></i> Registro de Animales</button></li>
                <li><button data-seccion="lista"><i class="fas fa-list"></i> Lista de Animales</button></li>
                <li><button data-seccion="arbol"><i class="fas fa-tree"></i> √Årbol Geneal√≥gico</button></li>
                <li><button data-seccion="estadisticas"><i class="fas fa-chart-bar"></i> Estad√≠sticas</button></li>
                <li><button data-seccion="sanidad"><i class="fas fa-heartbeat"></i> Sanidad</button></li>
                <li><button data-seccion="reproduccion"><i class="fas fa-heart"></i> Reproducci√≥n</button></li>
                <li><button data-seccion="partos"><i class="fas fa-baby"></i> Pr√≥ximos Partos</button></li>
                <li><button data-seccion="potreros"><i class="fas fa-tractor"></i> Potreros</button></li>
                <li><button data-seccion="finanzas"><i class="fas fa-coins"></i> Finanzas</button></li>
                <li><button data-seccion="inventario"><i class="fas fa-boxes"></i> Inventario</button></li>
                <li><button data-seccion="alertas"><i class="fas fa-bell"></i> Alertas</button></li>
                <li id="admin-menu-item" style="display: none;"><button data-seccion="admin"><i class="fas fa-user-shield"></i> Panel de Administraci√≥n <span class="admin-badge">Admin</span></button></li>
            </ul>
        </div>

        <main style="transition: margin-left 0.3s;">
            <section id="registro" class="seccion active">
                <h2>Registrar Nuevo Animal</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Completa todos los campos para registrar un nuevo animal en el sistema.
                </div>
                <div id="offline-registro-alert" class="alert alert-offline" style="display: none;">
                    <i class="fas fa-cloud-download-alt"></i> Est√°s trabajando sin conexi√≥n. Los datos se guardar√°n localmente y se sincronizar√°n cuando recuperes conexi√≥n.
                </div>
            </section>

            <section id="lista" class="seccion">
                <h2>Lista de Animales</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Lista completa de animales registrados en el sistema.
                </div>
                <div id="offline-lista-alert" class="alert alert-offline" style="display: none;">
                    <i class="fas fa-cloud-download-alt"></i> Est√°s viendo datos almacenados localmente. Algunos datos pueden estar desactualizados.
                </div>
            </section>

            <section id="arbol" class="seccion">
                <h2>√Årbol Geneal√≥gico</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Selecciona un animal para ver su √°rbol geneal√≥gico.
                </div>
                <div id="offline-arbol-alert" class="alert alert-offline" style="display: none;">
                    <i class="fas fa-cloud-download-alt"></i> Est√°s viendo datos almacenados localmente. Algunos datos pueden estar desactualizados.
                </div>
            </section>

            <section id="estadisticas" class="seccion">
                <h2>Estad√≠sticas</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Estad√≠sticas de tu ganado.
                </div>
                
                <div style="transition: margin-left 0.3s;">
                    <div id="nivel-ancestros" class="nivel-arbol nivel-ancestros">
                        <h2>Distribuci√≥n por Categor√≠a</h2>
                        <div id="graficoDistribucion"></div>
                    </div>
                    
                    <div id="nivel-descendientes" class="nivel-arbol nivel-descendientes">
                        <h2>Estad√≠sticas Actuales</h2>
                        
                        <div class="stat-card">
                            <h3>Total de Animales</h3>
                            <div class="stat-value" id="totalAnimales">0</div>
                        </div>
                        
                        <div class="stats-container">
                            <div class="stat-card">
                                <h3>Vacas</h3>
                                <div class="stat-value" id="totalVacas">0</div>
                            </div>
                            
                            <div class="stat-card">
                                <h3>Toros</h3>
                                <div class="stat-value" id="totalToros">0</div>
                            </div>
                            
                            <div class="stat-card">
                                <h3>Machos Peque√±os</h3>
                                <div class="stat-value stat-male" id="totalMachosPeq">0</div>
                            </div>
                            
                            <div class="stat-card">
                                <h3>Hembras Peque√±as</h3>
                                <div class="stat-value stat-female" id="totalHembrasPeq">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sanidad" class="seccion">
                <h2>Registro de Tratamientos</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Registro de tratamientos para llevar un control de la sanidad en tu ganado.
                </div>
                
                <form id="formSanidad">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ID Animal:</label>
                            <input type="text" id="animalId" placeholder="ID Animal (auto)" disabled>
                        </div>
                        <div class="form-group">
                            <label>Arete:</label>
                            <input type="text" id="arete" placeholder="N√∫mero de Arete">
                        </div>
                        <div class="form-group">
                            <label>Tipo Tratamiento:</label>
                            <input type="text" id="tipoTratamiento" placeholder="Vacunaci√≥n, Desparasitaci√≥n...">
                        </div>
                        <div class="form-group">
                            <label>Detalles:</label>
                            <textarea id="detallesSanidad"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-syringe"></i> Registrar Tratamiento</button>
                </form>

                <h3 style="transition: margin-left 0.3s;">Historial de Tratamientos</h3>
                <div id="historialSanidad">
                    <p>No hay tratamientos registrados</p>
                </div>
            </section>

            <section id="reproduccion" class="seccion">
                <h2>Registro de Reproducci√≥n</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Registra las montas para llevar un control de la reproducci√≥n en tu ganado.
                </div>

                <form id="formReproduccion">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>ID Vaca:</label>
                            <select id="animalSanidad" required></select>
                        </div>
                        <div class="form-group">
                            <label>ID Toro:</label>
                            <select id="toro" required></select>
                        </div>
                        <div class="form-group">
                            <label>Fecha Monta:</label>
                            <input type="date" id="fechaMonta" required>
                        </div>
                        <div class="form-group">
                            <label>M√©todo:</label>
                            <select id="metodo" required></select>
                        </div>
                        <div class="form-group">
                            <label>Observaciones:</label>
                            <textarea id="observacionesReproduccion"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-reproduction"><i class="fas fa-heart"></i> Registrar Monta</button>
                </form>

                <h3 style="transition: margin-left 0.3s;">Historial de Reproducci√≥n</h3>
                <div id="historialReproduccion">
                    <p>No hay registros de reproducci√≥n</p>
                </div>
            </section>

            <section id="partos" class="seccion">
                <h2>Pr√≥ximos Partos</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Lista de vacas con partos programados en los pr√≥ximos meses.
                </div>

                <div id="listaPartos">
                    <p>Cargando pr√≥ximos partos...</p>
                </div>
            </section>

            <section id="potreros" class="seccion">
                <h2>Gesti√≥n de Potreros</h2>
                <form id="formPotreros">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre del Potrero:</label>
                            <input type="text" id="nombrePotrero" placeholder="Ej: Potrero Norte" required>
                        </div>
                        <div class="form-group">
                            <label>√Årea (hect√°reas):</label>
                            <input type="number" id="areaPotrero" placeholder="Ej: 5.2" min="0.1" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label>Capacidad:</label>
                            <input type="number" id="capacidadPotrero" placeholder="N√∫mero de animales" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n:</label>
                            <textarea id="descripcionPotrero" placeholder="Caracter√≠sticas del potrero"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Agregar Potrero</button>
                </form>

                <h3 style="transition: margin-left 0.3s;">Lista de Potreros</h3>
                <div id="listaPotreros">
                    <p>No hay potreros registrados</p>
                </div>
            </section>

            <section id="finanzas" class="seccion">
                <h2>Gesti√≥n Financiera</h2>
                <form id="formFinanzas">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Fecha:</label>
                            <input type="date" id="fechaFinanza" required>
                        </div>
                        <div class="form-group">
                            <label>Tipo:</label>
                            <select id="tipoFinanza" required>
                                <option value="Ingreso">Ingreso</option>
                                <option value="Egreso">Egreso</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n:</label>
                            <input type="text" id="descripcionFinanza" placeholder="Venta de leche, Compra de alimento...">
                        </div>
                        <div class="form-group">
                            <label>Monto ($):</label>
                            <input type="number" id="montoFinanza" placeholder="0.00" min="0" step="0.01" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Registrar Movimiento</button>
                </form>

                <h3 style="transition: margin-left 0.3s;">Resumen Financiero</h3>
                <div id="resumenFinanciero">
                    <p>No hay datos financieros de registrados</p>
                </div>
                
                <h3 style="transition: margin-left 0.3s;">Historial de Movimientos</h3>
                <div id="historialFinanzas">
                    <p>No hay movimientos registrados</p>
                </div>
            </section>

            <section id="inventario" class="seccion">
                <h2>Gesti√≥n de Inventario</h2>
                <form id="formInventario">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>√çtem:</label>
                            <input type="text" id="nombreItem" placeholder="Alimento concentrado, Medicamentos..." required>
                        </div>
                        <div class="form-group">
                            <label>Cantidad:</label>
                            <input type="number" id="cantidadItem" placeholder="0" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>Categor√≠a:</label>
                            <select id="categoriaItem" required>
                                <option value="Alimento">Alimento</option>
                                <option value="Medicina">Medicina</option>
                                <option value="Equipo">Equipo</option>
                                <option value="Otros">Otros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Descripci√≥n:</label>
                            <textarea id="descripcionItem" placeholder="Detalles del √≠tem"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Agregar al Inventario</button>
                </form>

                <h3 style="transition: margin-left 0.3s;">Inventario Actual</h3>
                <div id="listaInventario">
                    <p>No hay √≠tems en el inventario de registrados</p>
                </div>
            </section>

            <section id="alertas" class="seccion">
                <h2>Alertas y Recordatorios</h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Sistema de alertas para pr√≥ximos partos, vacunas y otros eventos importantes.
                </div>

                <div id="listaAlertas">
                    <p>No hay alertas activas en este momento</p>
                </div>
            </section>

            <section id="admin" class="seccion">
                <h2><i class="fas fa-user-shield"></i> Panel de Administraci√≥n <span class="admin-badge">Admin</span></h2>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Esta secci√≥n es exclusiva para el administrador del sistema.
                </div>

                <form id="admin-register-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Nombre completo:</label>
                            <input type="text" id="admin-nombre" placeholder="Nombre completo" required>
                        </div>
                        <div class="form-group">
                            <label>Correo electr√≥nico:</label>
                            <input type="email" id="admin-email" placeholder="Correo electr√≥nico" required>
                        </div>
                        <div class="form-group">
                            <label>Contrase√±a:</label>
                            <input type="password" id="admin-password" placeholder="Contrase√±a (m√≠n. 6 caracteres)" required minlength="6">
                        </div>
                    </div>
                    <button type="submit" id="btnAdminRegister"><i class="fas fa-user-plus"></i> Crear Nuevo Usuario</button>
                </form>

                <h3 style="transition: margin-left 0.3s;">Usuarios Registrados</h3>
                <div id="usuarios-container">
                    <p>No hay usuarios registrados en el sistema</p>
                </div>
            </section>
        </main>

        <div id="fichaIndividual" class="ficha" style="display: none;">
            <button class="cerrarFicha">√ó</button>
            <div id="fichaContent"></div>
        </div>
        
        <div id="conflictResolver" class="conflict-resolver">
            <div class="conflict-box">
                <div class="conflict-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Resolver Conflicto</h3>
                    <p>Se detect√≥ un conflicto entre tus cambios locales y los cambios en el servidor.</p>
                </div>

                <div class="conflict-versions">
                    <div id="versionCardServer" class="version-card current"></div>
                    <div id="versionCardLocal" class="version-card pending"></div>
                </div>

                <div class="conflict-actions">
                    <button id="btnKeepServer"><i class="fas fa-cloud-download-alt"></i> Mantener versi√≥n del servidor</button>
                    <button id="btnKeepLocal"><i class="fas fa-laptop"></i> Mantener mis cambios</button>
                    <button id="btnMerge"><i class="fas fa-code-merge"></i> Combinar cambios</button>
                </div>
            </div>
        </div>
        
        <div id="offline-indicator" class="offline-indicator" style="display: none;">
            <i class="fas fa-wifi-slash"></i>
            <span>Sin conexi√≥n</span>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCFx1TJ-4Zpkp5cIqcmfSgELoM8clXeXhg",
            authDomain: "castellum-a3168.firebaseapp.com",
            projectId: "castellum-a3168",
            storageBucket: "castellum-a3168.appspot.com",
            messagingSenderId: "846392453985",
            appId: "1:846392453985:web:9ffa30b373b8913f6d7320",
            measurementId: "G-7XC0BV0RJB"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Habilitar persistencia de datos para funcionamiento offline
        db.enablePersistence()
            .catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.warn("Persistencia fallida: M√∫ltiples pesta√±as abiertas");
                } else if (err.code === 'unimplemented') {
                    console.warn("Persistencia no soportada en este navegador");
                } else {
                    console.error("Error al habilitar persistencia: ", err);
                }
            });

        // UID del administrador
        const ADMIN_UID = "wmaUD6CKl2WKkS6x59mFAw4Awxe2";

        // Referencias a elementos
        const loginContainer = document.getElementById('login-container');
        const mainApp = document.getElementById('main-app');
        const loginButton = document.getElementById('login-button');
        const loginSpinner = document.getElementById('login-spinner');
        const connectionStatus = document.querySelector('.connection-status');
        const statusDot = document.querySelector('.status-dot');
        const statusText = document.querySelector('.status-text');
        const userAvatar = document.getElementById('user-avatar');
        const adminMenuItem = document.getElementById('admin-menu-item');
        const offlineIndicator = document.getElementById('offline-indicator');
        const offlineRegistroAlert = document.getElementById('offline-registro-alert');
        const offlineListaAlert = document.getElementById('offline-lista-alert');
        const offlineSanidadAlert = document.getElementById('offline-sanidad-alert');

        // Variables globales
        let animalesData = [];
        let tratamientosData = [];
        let potrerosData = [];
        let isOnline = navigator.onLine;
        let pendingWrites = []; // Para operaciones pendientes de sincronizaci√≥n

        // ======================
        // FUNCIONALIDAD OFFLINE MEJORADA
        // ======================
        
        // Funci√≥n para actualizar estado de conexi√≥n
        function updateConnectionStatus(connected) {
            isOnline = connected;

            if (connected) {
                statusDot.classList.add('connected');
                statusDot.classList.remove('disconnected', 'offline');
                statusText.textContent = 'Conectado';
                offlineIndicator.style.display = 'none';

                offlineRegistroAlert.style.display = 'none';
                offlineListaAlert.style.display = 'none';
                offlineSanidadAlert.style.display = 'none';

                // Iniciar sincronizaci√≥n inmediata al recuperar conexi√≥n
                syncPendingWrites();
            } else {
                statusDot.classList.add('disconnected');
                statusDot.remove('connected', 'offline');
                statusText.textContent = 'Sin conexi√≥n';
                offlineIndicator.style.display = 'flex';

                // Detener sincronizaci√≥n
                if (syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = null;
                }

                // Mostrar alertas offline en secciones activas
                const activeSections = ['registro', 'lista', 'sanidad'];
                activeSections.forEach(sectionId => {
                    if (document.getElementById(sectionId).classList.contains('active')) {
                        showNotification(`Datos ${sectionId} almacenados localmente`, 'offline');
                    }
                });
            }
        }

        // Monitorear estado de conexi√≥n
        window.addEventListener('online', () => updateConnectionStatus(true));
        window.addEventListener('offline', () => updateConnectionStatus(false));
        updateConnectionStatus(navigator.onLine);

        // Guardar datos localmente para acceso offline
        function saveLocalData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error("Error guardando datos locales: ", e);
                if (e.name === 'QuotaExceededError') {
                    localStorage.clear();
                    saveLocalData(key, data);
                }
            }
        }

        // Obtener datos locales
        function getLocalData(key) {
            try {
                return JSON.parse(localStorage.getItem(key)) || [];
            } catch (e) {
                console.error("Error leyendo datos locales: ", e);
                return [];
            }
        }

        // Sincronizar operaciones pendientes
        async function syncPendingWrites() {
            if (pendingWrites.length === 0 || !isOnline) return;

            const user = auth.currentUser;
            if (!user) return;

            try {
                for (let i = 0; i < pendingWrites.length; i++) {
                    const operation = pendingWrites[i];

                    if (operation.type === 'saveAnimal') {
                        const animalRef = db.collection('users').doc(user.uid)
                            .collection('animales').doc(operation.data.id);

                        let serverDoc;
                        try {
                            serverDoc = await animalRef.get();
                        } catch (e) {
                            console.warn("Operaci√≥n pendiente de saveAnimal: ", e);
                            continue;
                        }

                        const serverData = serverDoc.exists ? serverDoc.data() : {};

                        if (!serverDoc.exists || serverData.version && operation.data.version && serverData.version > operation.data.version) {
                            showConflictResolver(serverData, operation.data);
                        } else {
                            await animalRef.set(operation.data);
                            pendingWrites.splice(i, 1);
                            saveLocalData('pendingWrites', pendingWrites);
                        }
                    } else if (operation.type === 'deleteAnimal') {
                        const animalId = operation.data.id;
                        const animalDoc = db.collection('users').doc(user.uid)
                            .collection('animales').doc(animalId);

                        try {
                            await animalRef.delete();
                            pendingWrites.splice(i, 1);
                            saveLocalData('pendingWrites', pendingWrites);
                        } catch (e) {
                            console.warn("Operaci√≥n pendiente de deleteAnimal: ", e);
                        }
                    } else if (operation.type === 'saveTratamiento') {
                        const tratamientoRef = db.collection('users').doc(user.uid)
                            .collection('tratamientos').doc(operation.data.id);

                        try {
                            await tratamientoRef.set(operation.data);
                            pendingWrites.splice(i, 1);
                            saveLocalData('pendingWrites', pendingWrites);
                        } catch (e) {
                            console.warn("Operaci√≥n pendiente de saveTratamiento: ", e);
                        }
                    }

                    if (!isOnline && pendingWrites.length > 0) showNotification(`Algunos datos ${sectionId} requieren atenci√≥n`, 'warning');
                }
            } catch (error) {
                console.error("Error sincronizando operaciones pendientes: ", error);
            }
        }

        // Agregar operaci√≥n pendiente para sincronizaci√≥n posterior
        function addPendingWrite(type, data) {
            pendingWrites.push({ type, data });
            saveLocalData('pendingWrites', pendingWrites);
        }

        // Cargar operaciones pendientes desde localStorage al iniciar
        function loadPendingWrites() {
            const savedWrites = getLocalData('pendingWrites');
            if (savedWrites) {
                pendingWrites = savedWrites;
                syncPendingWrites(); // Sincronizar inmediatamente al cargar
            }
        }

        // Iniciar intervalo de sincronizaci√≥n
        function startSyncInterval() {
            const user = auth.currentUser;
            if (!user || user.uid !== ADMIN_UID) return;

            syncInterval = setInterval(() => {
                if (isOnline) {
                    syncPendingWrites();
                } else {
                    showNotification(`Algunos datos ${sectionId} requieren atenci√≥n`, 'warning');
                }
            }, 15000); // Sincronizar cada 15 segundos
        }

        // ======================
        // RESOLUCI√ìN DE CONFLICTOS
        // ======================
        
        function showConflictResolver(serverData, localData) {
            const resolver = document.getElementById('conflictResolver');
            const serverContent = document.getElementById('versionCardServer');
            const localContent = document.getElementById('versionCardLocal');

            serverContent.innerHTML = `
                <h4>
                    ${serverData.nombre} (${serverData.id})
                    ${serverData.categoria}
                    ${serverData.sexo === 'Macho' ? '<span class="stat-male">(Macho)</span>' : ''}
                    ${serverData.sexo === 'Hembra' ? '<span class="stat-female">(Hembra)</span>' : ''}
                </h4>
                <p>${calcularEdad(serverData.fechaNacimiento)} - 
                ${serverData.estado} (${serverData.categoria})
                ${serverData.padre && serverData.sexo === 'Macho' ? '<span class="stat-male">(Padre)</span>' : ''}
                ${serverData.madre && serverData.sexo === 'Hembra' ? '<span class="stat-female">(Madre)</span>' : ''}</p>
            `;

            localContent.innerHTML = `
                <h4>
                    ${calcularEdad(localData.fechaNacimiento)} - 
                    ${localData.estado} (${localData.categoria})
                    ${localData.padre && localData.sexo === 'Macho' ? '<span class="stat-male">(Padre)</span>' : ''}
                    ${localData.madre && localData.sexo === 'Hembra' ? '<span class="stat-female">(Madre)</span>' : ''}</p>
                <p>${calcularEdad(localData.fechaNacimiento)} - 
                    ${localData.estado} (${localData.categoria})
                    ${localData.padre && localData.sexo === 'Macho' ? '<span class="stat-male">(Padre)</span>' : ''}
                    ${localData.madre && localData.sexo === 'Hembra' ? '<span class="stat-female">(Madre)</span>' : ''}</p>
            `;
            
            resolver.style.display = 'flex';
        }

        // Calcular edad
        function calcularEdad(fechaNacimiento) {
            const nacimiento = new Date(fechaNacimiento);
            const hoy = new Date();
            let edad = hoy.getFullYear() - nacimiento.getFullYear();

            if (hoy.getMonth() < nacimiento.getMonth()) {
                edad--;
            } else if (hoy.getMonth() === nacimiento.getMonth() && hoy.getDate() < nacimiento.getDate()) {
                edad--;
            }

            return edad >= 0 ? edad + " a√±os" : "N/A";
        }
        
        // ======================
        // M√ìDULO DE REGISTROS
        // ======================
        async function saveAnimal() {
            const user = auth.currentUser;
            if (!user) {
                showNotification('Debe iniciar sesi√≥n', 'error');
                return;
            }

            try {
                let animalId = document.getElementById('id').value || 'id-' + Date.now();
                
                const areteInput = document.getElementById('arete');
                const nombreInput = document.getElementById('nombre');

                if (!areteInput.value.trim() || !nombreInput.value.trim()) {
                    showNotification('El nombre y el arete son obligatorios', 'error');
                    return;
                }

                let animalData;

                if (isOnline) {
                    animalData = {
                        id: animalId,
                        arete: areteInput.value.trim(),
                        nombre: nombreInput.value.trim(),
                        categoria: document.getElementById('categoria').value,
                        sexo: document.getElementById('sexo').value,
                        raza: document.getElementById('raza').value.trim(),
                        peso: parseFloat(document.getElementById('peso').value) || 0,
                        fechaNacimiento: document.getElementById('fechaNacimiento').value,
                        estado: document.getElementById('estado').value,
                        padre: document.getElementById('padre').value.trim(),
                        madre: document.getElementById('madre').value.trim(),
                        observaciones: document.getElementById('observaciones').value.trim()
                    };
                    
                    animalData.lastUpdated = firebase.firestore.FieldValue.serverTimestamp();
                } else {
                    animalData = getLocalData(`animales_${user.uid}`, animalId);
                    areteInput.value = animalData.arete || '';
                    nombreInput.value = animalData.nombre;
                    document.getElementById('categoria').value = animalData.categoria;
                    document.getElementById('sexo').value = animalData.sexo;
                    document.getElementById('raza').value = animalData.raza || '';
                    document.getElementById('peso').value = animalData.peso.toFixed(1) || '0';
                    document.getElementById('fechaNacimiento').value = animalData.fechaNacimiento || '';
                    document.getElementById('estado').value = animalData.estado;
                    document.getElementById('padre').value = animalData.padre || '';
                    document.getElementById('madre').value = animalData.madre || '';
                    document.getElementById('observaciones').value = animalData.observaciones || '';

                    animalData.lastLocalUpdate = new Date().toISOString();
                }

                const areteError = document.getElementById('arete-error');
                const nombreError = document.getElementById('nombre-error');

                if (!/^[^\s@]+$/.test(anreteInput.value.trim())) {
                    areteError.textContent = 'Ingrese un correo v√°lido';
                    areteError.style.display = 'block';
                } else {
                    areteError.style.display = 'none';
                }

                if (nombreInput.value.trim().length < 6) {
                    nombreError.textContent = 'La contrase√±a debe tener al menos 6 caracteres';
                    nombreError.style.display = 'block';
                } else {
                    nombreError.style.display = 'none';
                }

                let animalRef;
                try {
                    animalRef = db.collection('users').doc(user.uid).collection('animales').doc(animalId);
                } catch (e) {
                    console.error("Error obteniendo referencia de animales: ", e);
                    showNotification('Error al obtener la referencia del animales', 'error');
                    return;
                }

                if (isOnline) {
                    await animalRef.set(animalData);
                } else {
                    const offlineVersion = `offline_${animalId}`;
                    saveLocalData(offlineVersion, animalData);

                    // Actualizar datos locales
                    let localAnimals = getLocalData(`animales_${user.uid}`);
                    if (localAnimals) {
                        localAnimals.push(animalData);
                        localAnimals.sort((a, b) => a.version - b.version);
                        animalesData = localAnimals;
                        renderAnimalList();
                    }
                }

                showNotification(
                    isOnline ? 'Animal registrado' : `Animal ${isOnline ? '' : 'actualizado'} guardado localmente`, 
                    isOnline ? 'success' : 'info'
                );

                // Limpiar formulario
                document.getElementById('formRegistro').reset();

                if (isOnline) {
                    loadAnimalsForSelects();
                    loadAnimalsForSanidad();
                }

                renderEstadisticas();

            } catch (error) {
                console.error("Error registrando animal: ", error);
                showNotification(`Error al registrar animal: ${error.message}`, 'error');
            }
        }

        // ======================
        // M√ìDULO DE LISTAS
        // ======================
        async function renderAnimalList() {
            try {
                const tbody = document.getElementById('tablaAnimales');
                if (!tbody) return;

                tbody.innerHTML = '';

                animalesData.forEach(animal => {
                    const edad = calcularEdad(animal.fechaNacimiento);

                    const tr = document.createElement('tr');
                    const idCell = document.createElement('td');
                    const areteCell = document.createElement('td');
                    const nombreCell = document.createElement('td');
                    const categoriaCell = document.createElement('td');
                    const sexoCell = document.createElement('td');
                    const pesoCell = document.createElement('td');
                    const estadoCell = document.createElement('td');

                    idCell.textContent = `${animal.id} ${isOnline ? '' : animal.pendingSync ? '<span class="offline-badge">(offline)</span>' : ''}`;
                    areteCell.textContent = animal.arete || '-';
                    nombreCell.textContent = animal.nombre;
                    categoriaCell.textContent = animal.categoria;
                    sexoCell.textContent = animal.sexo;
                    pesoCell.textContent = animal.peso.toFixed(1) || '0';
                    estadoCell.textContent = animal.estado;

                    tr.appendChild(idCell);
                    tr.appendChild(areteCell);
                    tr.appendChild(nombreCell);
                    tr.appendChild(categoriaCell);
                    tr.appendChild(sexoCell);
                    tr.appendChild(pesoCell);
                    tr.appendChild(estadoCell);

                    const accionesCell = document.createElement('td');
                    accionesCell.className = 'acciones-cell';
                    accionesCell.innerHTML = `
                        <button class="btn-ver" data-id="${animal.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-editar" data-id="${animal.id}" style="display: ${isOnline ? '' : 'none'};">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-eliminar" data-id="${animal.id}" style="display: ${isOnline ? '' : 'none'};">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    tr.appendChild(accionesCell);

                    tbody.appendChild(tr);
                });

                // Configurar event listeners
                document.querySelectorAll('.btn-ver').forEach(btn => {
                    btn.addEventListener('click', () => viewAnimal(btn.dataset.id));
                });
                
                if (isOnline) {
                    loadAnimalsForSelects();
                    loadAnimalsForSanidad();
                }
            } catch (error) {
                console.error("Error cargando animales: ", error);
                showNotification(`Error cargando la lista de animales: ${error.message}`, 'error');
            }
        }

        // ======================
        // M√ìDULO DE MODIFICACIONES EN LA LISTA
        // ======================

        async function loadAnimalsForSelects() {
            const selectPadre = document.getElementById('padre');
            selectMadre = document.getElementById('madre');

            try {
                animalesData.forEach(animal => {
                    const option = document.createElement('option');
                    option.value = animal.id;
                    option.textContent = `${animal.nombre} (${animal.id})`;
                    selectPadre.appendChild(option);
                    selectMadre.appendChild(option);
                });
                
                if (!isOnline) loadTratamientosHistorial(); // Cargar historial de tratamientos solo si offline
            } catch (error) {
                console.error("Error cargando animales para selects: ", error);
                showNotification(`Error cargando animales para los selectores: ${error.message}`, 'error');
            }
        }

        async function loadTratamientosHistorial() {
            const cont = document.getElementById('historialSanidad');
            if (!cont) return;

            try {
                const user = auth.currentUser;
                if (!user) return;

                tratamientosData = getLocalData(`tratamientos_${user.uid}`);

                if (tratamientosData.length === 0) {
                    cont.innerHTML = '<p>No hay tratamientos registrados</p>';
                    return;
                }

                let html = '';
                tratamientosData.forEach(tratamiento => {
                    const fecha = new Date(tratamiento.createdAt).toLocaleDateString();
                    html += `
                        <div class="alerta-card">
                            <h4>
                                ${tratamiento.animalNombre} - ${tratamiento.tipo}
                                ${isOnline ? '' : tratamiento.offlineId && `<span class="offline-badge">(offline)</span>`}</h4>
                            <p>${calcularEdad(tratamiento.fechaNacimiento)} - 
                            ${tratamiento.estado} (${tratamiento.categoria})
                            ${tratamiento.padre && tratamiento.sexo === 'Macho' ? '<span class="stat-male">(Padre)</span>' : ''}
                            ${tratamiento.madre && tratamiento.sexo === 'Hembra' ? '<span class="stat-female">(Madre)</span>' : ''}</p>
                        </div>
                    `;
                });
                
                cont.innerHTML = html;
            } catch (error) {
                console.error("Error cargando tratamientos historial: ", error);
                showNotification(`Error cargando el historial de tratamientos: ${error.message}`, 'error');
            }
        }

        // ======================
        // INICIALIZACI√ìN DE LA APP
        // ======================

        function initApp() {
            loadPendingWrites();
            
            db.collection('users').doc(user.uid).collection('animales').onSnapshot(snapshot => {
                let hasChanges = false;
                snapshot.docChanges().forEach(change => {
                    const animalData = change.doc.data();

                    if (change.type === 'added' || change.type === 'modified') {
                        hasChanges = true;

                        // Actualizar o agregar en animalesData seg√∫n sea necesario
                        const existingAnimalIndex = animalesData.findIndex(a => a.id === animalData.id);
                        if (existingAnimalIndex !== -1) {
                            animalesData[existingAnimalIndex] = animalData;
                        } else {
                            animalesData.push(animalData);
                        }
                    } else if (change.type === 'removed') {
                        hasChanges = true;

                        const index = animalesData.findIndex(a => a.id === animalData.id);
                        if (index !== -1) {
                            animalesData.splice(index, 1);
                        }
                    }

                    // Actualizar UI solo si estamos online
                    if (!isOnline && hasChanges) showNotification('Datos sincronizados correctamente', 'success');
                });

                // Guardar datos locales al completar snapshot
                saveLocalData(`animales_${user.uid}`, animalesData);

                // Configurar event listeners para navegaci√≥n solo en secciones activas
                const activeSections = ['registro', 'lista', 'sanidad'];
                activeSections.forEach(sectionId => {
                    if (document.getElementById(sectionId).classList.contains('active')) {
                        document.querySelectorAll(`.sidebar button[data-seccion="${sectionId}"]`).forEach(btn => {
                            btn.addEventListener('click', () => showSection(btn.dataset.seccion));
                        });
                        
                        // Evento de b√∫squeda
                        document.getElementById('busqueda').addEventListener('input', searchAnimals);
                    }
                });
            });

        function viewAnimal(id) {
            try {
                const animal = animalesData.find(a => a.id === id);

                if (animal) {
                    const cont = document.getElementById('fichaContent');
                    cont.innerHTML = `
                        <h3>${animal.nombre} (${animal.categoria})</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <p><strong>ID:</strong> ${animal.id}</p>
                                <p><strong>Arete:</strong> ${animal.arete || '-'}</p>
                                <p><strong>Raza:</strong> ${animal.raza}</p>
                                <p><strong>Peso:</strong> ${animal.peso.toFixed(1)} kg</p>
                                <p><strong>Sexo:</strong> ${animal.sexo}</p>
                            </div>
                            
                            <div>
                                <p><strong>Edad:</strong> ${calcularEdad(animal.fechaNacimiento)}</p>
                                <p>${animal.padre ? `<span class="stat-male">(Padre)</span>` : ''}</p>
                                <p>${animal.madre ? `<span class="stat-female">(Madre)</span>` : ''}</p>
                                <p><strong>Estado:</strong> ${animal.estado}</p>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <p><strong>Observaciones:</strong></p>
                            <p>${animal.observaciones || 'Ninguna'}</p>
                        </div>
                    `;
                } else {
                    showNotification('Animal no encontrado', 'error');
                }

                document.getElementById('fichaIndividual').style.display = 'block';
            } catch (error) {
                console.error("Error cargando animal: ", error);
                showNotification(`Error cargando la ficha del animal: ${error.message}`, 'error');
            }
        }

        // ======================
        // M√ìDULO DE ELIMINACI√ìN EN LA LISTA
        // ======================

        async function deleteAnimal(id) {
            const user = auth.currentUser;
            if (!user) return;

            try {
                const animalIndex = animalesData.findIndex(a => a.id === id);
                
                if (animalIndex !== -1 && !isOnline) {
                    showNotification('Este animal no se ha sincronizado a√∫n. ¬øDesea eliminarlo localmente?', 'warning');
                    const confirmDelete = await new Promise((resolve, reject) => {
                        const areteInput = document.getElementById('arete');
                        const nombreInput = document.getElementById('nombre');

                        const areteError = document.createElement('span');
                        areteError.textContent = 'Arete';
                        areteInput.parentElement.appendChild(areteError);

                        const nombreError = document.createElement('span');
                        nombreError.textContent = 'Nombre';
                        nombreInput.parentElement.appendChild(nombreError);

                        resolve(confirmDelete);
                    });
                    
                    if (confirmDelete) {
                        animalesData.splice(animalIndex, 1);
                        saveLocalData(`animales_${user.uid}`, animalesData);
                        
                        // Actualizar historial de tratamientos si el animal se elimin√≥ offline
                        tratamientosData = tratamientosData.filter(tratamiento => tratamiento.animalId !== id);

                        showNotification('Animal eliminado localmente', 'success');
                    } else {
                        showNotification('Operaci√≥n cancelada', 'info');
                    }
                } else if (animalIndex !== -1 && isOnline) {
                    await db.collection('users').doc(user.uid).collection('animales').doc(id).delete();
                    animalesData = animalesData.filter(a => a.id !== id);

                    showNotification('Animal eliminado', 'success');
                }
                
                renderAnimalList();

            } catch (error) {
                console.error("Error eliminando animal: ", error);
                showNotification(`Error al eliminar animal: ${error.message}`, 'error');
            }
        }

        // ======================
        // M√ìDULO DE EXPORTACI√ìN A EXCEL
        // ======================

        function exportToExcel() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                let data = animalesData.map(animal => ({
                    'ID': animal.id,
                    'Arete': animal.arete || '',
                    'Nombre': animal.nombre,
                    'Categor√≠a': animal.categoria,
                    'Sexo': animal.sexo,
                    'Raza': animal.raza || '',
                    'Peso (kg)': parseFloat(animal.peso) || 0,
                    'Fecha Nacimiento': animal.fechaNacimiento ? new Date(animal.fechaNacimiento).toISOString() : '',
                    'Estado': animal.estado,
                    'Padre': animal.padre || '',
                    'Madre': animal.madre || ''
                }));

                if (!data.length) {
                    showNotification('No hay datos para exportar', 'warning');
                    return;
                }

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(data);

                let fileName = 'ganado';
                if (isOnline) fileName += '-online.xlsx';

                XLSX.writeFile(wb, `${fileName}.xlsx`);
                showNotification('Datos exportados a Excel', isOnline ? 'success' : 'info');
            } catch (error) {
                console.error("Error exportando datos: ", error);
                showNotification(`Error al exportar datos: ${error.message}`, 'error');
            }
        }

        // ======================
        // M√ìDULO DE USUARIOS
        // ======================

        async function cargarUsuarios() {
            const cont = document.getElementById('usuarios-container');
            if (!cont) return;

            try {
                const usuariosRef = db.collection('users');

                let html = `
                    <table class="permisos-table">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Fecha Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                const snapshot = await usuariosRef.get();
                snapshot.docs.forEach(doc => {
                    const usuarioData = doc.data();

                    let fechaRegistro = usuarioData.createdAt ? 
                        new Date(usuarioData.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';

                    html += `
                        <tr>
                            <td>${usuarioData.nombre} ${doc.id === ADMIN_UID ? '<span class="admin-badge">Admin</span>' : ''}</td>
                            <td>${usuarioData.email}</td>
                            <td>${fechaRegistro}</td>
                            <td>
                                ${doc.id !== ADMIN_UID ? 
                                    `<button class="btn btn-danger btn-eliminar-usuario" data-id="${doc.id}">
                                        <i class="fas fa-trash"></i> Eliminar
                                    </button>` : 
                                    '<span class="btn btn-disabled">Administrador</span>'
                                }
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
                cont.innerHTML = html;

                document.querySelectorAll('.btn-eliminar-usuario').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const userId = btn.dataset.id;
                        
                        if (confirm(`¬øEliminar este usuario ${userId}? Esta acci√≥n no se puede deshacer.`)) {
                            try {
                                await db.collection('users').doc(userId).delete();
                                showNotification(`Usuario ${userId} eliminado`, 'success');
                                cargarUsuarios();
                            } catch (error) {
                                console.error("Error eliminando usuario: ", error);
                                showNotification(`Error al eliminar usuario ${userId}: ${error.message}`, 'error');
                            }
                        }
                    });
                });

            } catch (error) {
                console.error("Error cargando usuarios: ", error);
                showNotification(`Error cargando el historial de movimientos: ${error.message}`, 'error');
            }
        }

        // ======================
        // M√ìDULO DE ARBOL GENEAL√ìGICO
        // ======================

        async function renderArbolGenealogico() {
            const user = auth.currentUser;
            if (!user) return;

            try {
                const animalSelect = document.getElementById('animalRaiz');

                const animalId = animalSelect.value;
                
                if (animalId) {
                    let raiz, padre, madre;

                    raiz = animalesData.find(a => a.id === animalId);
                    
                    if (!raiz) {
                        showNotification('Animal no encontrado', 'offline');
                        return;
                    }

                    const nodoRaiz = crearNodoArbol(raiz, '', true);

                    let abuelosPaterno, abuelosMaterna;

                    abuelosPaterno = raiz.padre && animalesData.find(a => a.id === raiz.padre?.padre);
                    abuelosMaterna = raiz.madre && animalesData.find(a => a.id === raiz.madre?.madre);

                    if (abuelosPaterno) {
                        let abuelaPaterna;
                        for (let i = 0; i < animalSelect.options.length; i++) {
                            const option = animalSelect.options[i];
                            if (!option.value || option.value === abuelosPaterno.id) continue;

                            const animal = animalesData.find(a => a.id === option.value);
                            if (!animal) continue;

                            abuelaPaterna = crearNodoArbol(animal, 'Abuela', false);

                        }

                        const grupoPadres = document.createElement('div');
                        grupoPadres.className = 'grupo-padres';
                        grupoPadres.appendChild(nodoRaiz);
                        grupoPadres.appendChild(abuelaPaterna);
                    } else {
                        let abuelosMaterna;
                        for (let i = 0; i < animalSelect.options.length; i++) {
                            const option = animalSelect.options[i];
                            if (!option.value || option.value === abuelosMaterna.id) continue;

                            const animal = animalesData.find(a => a.id === option.value);
                            if (!animal) continue;

                            abuelaMaterna = crearNodoArbol(animal, 'Abuela', false);

                        }

                        const grupoPadres = document.createElement('div');
                        grupoPadres.className = 'grupo-padres';
                        grupoPadres.appendChild(nodoRaiz);
                        grupoPadres.appendChild(abuelaMaterna);
                    }
                    
                    const conexionVertical1 = document.createElement('div');
                    conexionVertical1.className = 'conexion vertical';

                    cont.innerHTML = '';
                    cont.appendChild(grupoPadres);
                    cont.appendChild(conexionVertical1);
                } else {
                    showNotification('No hay animal seleccionado', 'offline');
                }

            } catch (error) {
                console.error("Error cargando √°rbol geneal√≥gico: ", error);
                showNotification(`Error al cargar el √°rbol geneal√≥gico: ${error.message}`, 'offline');
            }
        }

        // ======================
        // M√ìDULO DE ESTAD√çSTICAS
        // ======================

        async function renderEstadisticas() {
            try {
                const user = auth.currentUser;
                if (!user) return;

                let vacas, toros, machosPeq, hembrasPeq, totalMachos, totalHembras, promedioPeso;

                vacas = animalesData.filter(a => a.categoria === 'Vaca');
                toros = animalesData.filter(a => a.categoria === 'Toro');
                machosPeq = animalesData.filter(a => 
                    (a.categoria === 'Ternero' || a.categoria === 'Novillo' || a.categoria === 'Becerro') && a.sexo === 'Macho'
                );
                hembrasPeq = animalesData.filter(a => 
                    (a.categoria === 'Ternero' || a.categoria === 'Novillo' || a.categoria === 'Becerro') && a.sexo === 'Hembra'
                );

                totalMachos = vacas.length + toros.length;
                totalHembras = vacas.length + hembrasPeq.length;

                promedioPeso = vacas.reduce((acc, animal) => acc + parseFloat(animal.peso || 0), 0);
                if (promedioPeso > 0) promedioPeso /= vacas.length;
                else promedioPeso = 0;

                const totalAnimalesElement = document.getElementById('totalAnimales');
                totalAnimalesElement.textContent = `Total de Animales: ${animalesData.length}`;

                const totalVacasElement = document.getElementById('totalVacas');
                totalVacasElement.textContent = `Total de Vacas: ${vacas.length}`;

                const totalTorosElement = document.getElementById('totalToros');
                totalTorosElement.textContent = `Total de Toros: ${toros.length}`;

                const totalMachosPeqElement = document.getElementById('totalMachosPeq');
                totalMachosPeqElement.textContent = `Total de Machos Peque√±os: ${machosPeq.length}`;

                const totalHembrasPeqElement = document.getElementById('totalHembrasPeq');
                totalHembrasPeqElement.textContent = `Total de Hembras Peque√±as: ${hembrasPeq.length}`;

                const totalMachosElement = document.getElementById('totalMachos');
                totalMachosElement.textContent = `Total de Machos: ${totalMachos} (${calcularPorcentaje(totalMachos, animalesData.length)})`;

                const totalHembrasElement = document.getElementById('totalHembras');
                totalHembrasElement.textContent = `Total de Hembras: ${totalHembras} (${calcularPorcentaje(totalHembras, animalesData.length)})`;

                const promedioPesoElement = document.getElementById('promedioPeso');
                promedioPesoElement.textContent = `Promedio de Peso: ${promedioPeso.toFixed(1)} kg (${calcularPorcentaje(promedioPeso, vacas.reduce((acc, animal) => acc + parseFloat(animal.peso || 0), 0))})`;

                function calcularPorcentaje(total, totalData) {
                    return (total / totalData * 100).toFixed(2);
                }

            } catch (error) {
                console.error("Error cargando estad√≠sticas: ", error);
                showNotification(`Error al cargar las estad√≠sticas: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
