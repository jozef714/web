<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión Ganadera</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🐄</text></svg>">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" 
          integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMm8e2LwA==" 
          crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* Estilos CSS completos */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
            --admin: #9b59b6;
            --male: #3498db;
            --female: #e84393;
            --reproduction: #e91e63;
            --offline: var(--danger); /* Corregido el color del offline indicator */
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light); /* Corregido el color del fondo */
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        #login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--primary)); /* Corregido el fondo de login-container */
        }
        
        .login-box {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .login-box h2 {
            margin-bottom: 25px;
            color: var(--primary);
            font-size: 28px;
        }
        
        .login-box input {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .login-box input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        .login-box button {
            width: 100%;
            padding: 12px;
            background-color: var(--success);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        .login-box button:hover {
            background-color: #219653;
        }
        
        .login-box button:disabled {
            background-color: var(--dark); /* Corregido el color del botón deshabilitado */
            cursor: not-allowed;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .logo i {
            font-size: 50px;
        }
        
        .logo h1 {
            color: var(--primary);
            font-size: 24px;
        }
        
        .error-message {
            color: var(--danger); /* Corregido el color del mensaje de error */
            font-size: 14px;
            margin-top: -15px;
            margin-bottom: 15px;
            text-align: left;
            display: none;
        }
        
        #main-app {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .hamburger {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }
        
        .header-title h1 {
            font-size: 20px;
            font-weight: 600;
        }
        
        .header-title p {
            display: none;
        }
        
        .btn span {
            display: none;
        }
        
        .btn i {
            margin-right: 0;
        }
        
        .nivel-arbol {
            flex-wrap: wrap;
            gap: 15px; /* Corregido el espacio entre niveles del árbol */
        }
        
        .nodo-arbol {
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }
        
        .nodo-arbol.macho {
            border: 2px solid var(--male); /* Corregido el borde del nodo macho */
        }
        
        .nodo-arbol.hembra {
            border: 2px solid var(--female); /* Corregido el borde del nodo hembra */
        }
        
        .nodo-arbol.raiz {
            background-color: #d5f5e3;
            border-width: 4px; /* Corregido el ancho del borde raíz */
        }
        
        .nodo-arbol .nombre {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px; /* Corregido el espacio entre la descripción y el nombre del nodo */
        }
        
        .nodo-arbol .id {
            font-size: 12px;
            color: #777;
        }
        
        .nodo-arbol .tipo {
            font-style: italic;
            margin-top: 5px;
            font-size: 13px; /* Corregido el tamaño de la descripción del tipo */
        }
        
        .conexion {
            position: absolute;
            background-color: var(--offline); /* Corregido el color del indicator de conexión horizontal y vertical */
            z-index: 0;
        }
        
        .conexion.horizontal {
            height: 2px;
            top: calc(50% - 1px);
            transform: translateY(-50%);
            border-left: 4px solid #999; /* Corregido el borde de conexión horizontal */
        }

        .conexion.vertical {
            width: 2px;
            left: calc(50% - 1px); 
            transform: translateX(-50%);
            border-top: 4px solid #999; /* Corregido el borde de conexión vertical */
        }
        
        .nivel-ancestros, .nivel-descendientes {
            margin-bottom: 20px; /* Corregido el espacio entre niveles del árbol */
        }
        
        .nodo-hijo::before {
            content: "";
            position: absolute;
            top: calc(50% - 1px); 
            left: calc(50% - 1px);
            width: 2px; 
            height: 20px;
            background-color: #999; /* Corregido el color del indicator de conexión */
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 220px;
                left: -220px;
            }
            
            .header-title h1 {
                font-size: 18px;
            }
            
            .header-title p {
                display: none;
            }
            
            .btn span {
                display: none;
            }
            
            .btn i {
                margin-right: 5px; /* Corregido el espacio entre el icono y el texto del botón */
            }
            
            .nivel-arbol {
                gap: 10px; /* Corregido el espacio entre niveles del árbol */
            }
            
            .nodo-arbol {
                margin: 5px;
            }
            
            .stats-container {
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 10px; /* Corregido el espacio entre columnas de estadísticas */
            }
            
            .conflict-versions {
                grid-template-columns: 1fr;
                gap: 5px; /* Corregido el espacio entre versiones en conflicto */
            }
            
            .conflict-actions {
                flex-direction: row; /* Corregido la dirección de los botones para resolución de conflictos */
            }
        }

        #sidebar {
            width: 250px;
            left: -250px;
            overflow-y: auto;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .sidebar.show {
            left: 0;
        }

        #conflictResolver, #offline-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 3000;
        }
        
        #conflictResolver {
            background-color: var(--danger); /* Corregido el color del indicador de conflicto */
            display: none;
        }
        
        .notification {
            position: relative;
            margin-bottom: 20px; /* Corregido el espacio entre las notificaciones */
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 3000;
        }
        
        .notification-success {
            background-color: var(--success); /* Corregido el color de las notificaciones exitosas */
        }

        .notification-offline {
            background-color: var(--offline); /* Corregido el color de las notificaciones offline */
            border-left: 4px solid #999; /* Corregido el borde de la notificación offline */
        }
        
        .alert, .potrero-card, .alerta-card, .parto-card, .finanza-card {
            transition: background-color 0.3s ease;
        }

        .alert-primary { /* Corregido el nombre del estilo */
            background-color: var(--secondary); /* Corregido el color de la alerta primary */
        }
        
        .alert-danger { /* Corregido el nombre del estilo */
            background-color: var(--danger); /* Corregido el color de la alerta danger */
        }
        
        .alert-info { /* Corregido el nombre del estilo */
            background-color: #d1ecf1; /* Corregido el color de la alerta info */
        }
        
        .alert-warning { /* Corregido el nombre del estilo */
            background-color: var(--warning); /* Corregido el color de la alerta warning */
        }

        .admin-actions button {
            flex: 0;
            width: calc(50% - 10px);
        }

        .admin-badge, .nivel-arbol .nombre { /* Corregido los estilos del admin-badge y el nivel Arbol nombre */
            font-weight: bold;
            color: white; /* Corregido el color del admin-badge y el nivel Arbol nombre */
            border-radius: 4px;
            padding: 2px 5px; /* Corregido el tamaño de los admin-badge y el nivel Arbol nombre */
        }

        .admin-badge:hover, .nivel-arbol .nombre:hover { /* Corregidos los estilos hover del admin-badge y el nivel Arbol nombre */
            background-color: #8e44ad; /* Corregido el color de los admin-badge y el nivel Arbol nombre al pasar por encima */
        }
    </style>
</head>
<body>
    <div id="login-container">
        <div class="login-box">
            <div class="logo">
                <i class="fas fa-cow"></i>
                <h1>Gestión Ganadera</h1>
            </div>
            <h2>Iniciar Sesión</h2>
            <form id="login-form">
                <input type="email" id="email" placeholder="Correo electrónico" required>
                <div class="error-message" id="email-error"></div>
                
                <input type="password" id="password" placeholder="Contraseña" required>
                <div class="error-message" id="password-error"></div>
                
                <button type="submit" id="login-button">
                    <i class="fas fa-sign-in-alt"></i> 
                    <span id="login-button-text">Iniciar Sesión</span>
                    <i class="fas fa-spinner fa-spin" id="login-spinner" style="display: none;"></i>
                </button>
            </form>
        </div>
    </div>

    <div id="main-app" style="display: none;">
        <header>
            <div class="header-left">
                <button id="menuHamburguesa" class="hamburger">☰</button>
                <div class="header-title">
                    <h1>Sistema de Gestión Ganadera</h1>
                    <p>Administración integral de tu ganado</p>
                </div>
            </div>
            <div class="header-right">
                <button id="btnExportar" class="btn btn-primary"><i class="fas fa-file-excel"></i> <span>Exportar</span></button>
                <div class="connection-status">
                    <div class="status-dot"></div>
                    <span class="status-text">Conectando...</span>
                </div>
            </div>
        </header>

        <div id="sidebar" class="sidebar">
            <ul>
                <li><button data-seccion="registro" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Registrar Nuevo Animal</button></li>
                <li><button data-seccion="lista" class="btn btn-primary"><i class="fas fa-list"></i> Lista de Animales</button></li>
                <li><button data-seccion="arbol" class="btn btn-primary"><i class="fas fa-tree"></i> Árbol Genealógico</button></li>
                <li><button data-seccion="estadisticas" class="btn btn-primary"><i class="fas fa-chart-bar"></i> Estadísticas</button></li>
                <li><button data-seccion="sanidad" class="btn btn-primary"><i class="fas fa-heartbeat"></i> Sanidad</button></li>
                <li><button data-seccion="reproduccion" class="btn btn-danger"><i class="fas fa-heart"></i> Reproducción</button></li>
                <li><button data-seccion="partos" class="btn btn-primary"><i class="fas fa-baby"></i> Próximos Partos</button></li>
                <li><button data-seccion="potreros" class="btn btn-primary"><i class="fas fa-tractor"></i> Potreros</button></li>
                <li><button data-seccion="finanzas" class="btn btn-primary"><i class="fas fa-coins"></i> Finanzas</button></li>
                <li><button data-seccion="inventario" class="btn btn-primary"><i class="fas fa-boxes"></i> Inventario</button></li>
            </ul>
        </div>

        <main>
            <section id="registro" class="seccion active">
                <h2>Registrar Nuevo Animal</h2>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> 
                    <span id="guardar-text">Animal registrado con éxito</span>
                    <button id="cerrarGuardado" class="btn btn-secondary">×</button>
                </div>

                <!-- Agregar indicador offline -->
                <div id="offline-registro-alert" class="alert alert-offline">
                    <i class="fas fa-cloud-download-alt"></i> 
                    <span>Sin conexión</span>
                    <button id="cerrarOfflineRegistro" class="btn btn-secondary">×</button>
                </div>

                <form id="formRegistro">
                    <div class="form-grid">
                        <!-- Campos de formulario -->
                        <input type="text" id="id" placeholder="ID (auto)" disabled>
                        <div class="form-group">
                            <label>ID:</label>
                            <input type="text" id="id" placeholder="ID (auto)" required>
                        </div>

                        <div class="form-group">
                            <label>Arete:</label>
                            <input type="text" id="arete" placeholder="Número de Arete">
                        </div>

                        <div class="form-group">
                            <label>Nombre:</label>
                            <input type="text" id="nombre" placeholder="Nombre" required>
                        </div>

                        <!-- Agregar indicador offline -->
                        <div id="offline-animal-id-alert" class="alert alert-offline"></div>

                        <div class="form-group">
                            <label>Categoría:</label>
                            <select id="categoria" required>
                                <option value="Vaca">Vaca</option>
                                <option value="Toro">Toro</option>
                                <option value="Ternero">Ternero</option>
                                <option value="Novillo">Novillo</option>
                                <option value="Becerro">Becerro</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <!-- Campos de formulario -->
                            <label>Sexo:</label>
                            <select id="sexo" required>
                                <option value="Macho">Macho</option>
                                <option value="Hembra">Hembra</option>
                            </select>
                        </div>

                        <!-- Agregar indicador offline -->
                        <div id="offline-animal-sexo-alert" class="alert alert-offline"></div>

                        <div class="form-group">
                            <!-- Campos de formulario -->
                            <label>Raza:</label>
                            <input type="text" id="raza" placeholder="Raza" required>
                        </div>

                        <!-- Agregar indicador offline -->
                        <div id="offline-animal-raza-alert" class="alert alert-offline"></div>

                        <!-- Campos de formulario -->
                        <div class="form-group">
                            <label>Peso (kg):</label>
                            <input type="number" id="peso" placeholder="Peso (kg)" required min="0" step="0.1">
                        </div>

                        <!-- Agregar indicador offline -->
                        <div id="offline-animal-peso-alert" class="alert alert-offline"></div>

                        <!-- Campos de formulario -->
                        <div class="form-group">
                            <label>Fecha de nacimiento:</label>
                            <input type="date" id="fechaNacimiento" required>
                        </div>

                        <!-- Agregar indicador offline -->
                        <div id="offline-animal-fnacimiento-alert" class="alert alert-offline"></div>

                        <!-- Campos de formulario -->
                        <div class="form-group">
                            <label>Estado:</label>
                            <select id="estado" required>
                                <option value="Activo">Activo</option>
                                <option value="Inactivo">Inactivo</option>
                                <option value="Vendido">Vendido</option>
                                <option value="Muerto">Muerto</option>
                            </select>
                        </div>

                        <!-- Agregar indicador offline -->
                        <div id="offline-animal-estado-alert" class="alert alert-offline"></div>

                        <!-- Campos de formulario -->
                        <div class="form-group">
                            <label>ID Padre:</label>
                            <select id="padre" required>
                                <option value="">Seleccionar padre</option>
                            </select>
                        </div>

                        <!-- Agregar indicador offline -->
                        <div id="offline-animal-padre-alert" class="alert alert-offline"></div>

                        <!-- Campos de formulario -->
                        <div class="form-group">
                            <label>ID Madre:</label>
                            <select id="madre" required>
                                <option value="">Seleccionar madre</option>
                            </select>
                        </div>

                        <!-- Agregar indicador offline -->
                        <div id="offline-animal-madre-alert" class="alert alert-offline"></div>
                    </div>
                    <div class="form-group">
                        <!-- Campos de formulario -->
                        <label>Observaciones:</label>
                        <textarea id="observaciones" placeholder="Observaciones adicionales..."></textarea>
                    </div>
                    
                    <!-- Mostrar spinner offline -->
                    <button type="submit" disabled id="btnGuardarAnimal">
                        <i class="fas fa-save"></i> 
                        <span id="guardar-text">Guardando...</span>
                        <i class="fas fa-spinner fa-spin" id="guardar-spinner" style="display: none;"></i>
                    </button>

                    <!-- Mostrar alerta offline en sección activas -->
                    <div id="offline-lista-alert" class="alert alert-offline" style="display: none;">
                        <i class="fas fa-cloud-download-alt"></i> 
                        Estás viendo datos almacenados localmente. Algunos datos pueden estar desactualizados.
                    </div>
                </form>
            </section>

            <!-- Agregar indicador offline -->
            <section id="lista" class="seccion">
                <h2>Lista de Animales</h2>
                
                <!-- Mostrar spinner offline -->
                <div id="offline-lista-alert" class="alert alert-offline" style="display: none;">
                    <i class="fas fa-cloud-download-alt"></i> 
                    Se están cargando datos desde el servidor. Algunos datos pueden estar desactualizados.
                </div>
                
                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnExportar">
                    <i class="fas fa-file-excel"></i> 
                    Exportar
                </button>

                <form id="formSanidad">
                    <!-- Campos de formulario -->
                    <select id="animalSanidad" required>
                        <option value="">Seleccione un animal</option>
                    </select>

                    <!-- Mostrar spinner offline -->
                    <input type="date" id="fechaSanidad" required>
                    
                    <!-- Mostrar spinner offline -->
                    <input type="text" id="tipoTratamiento" placeholder="Vacunación, Desparasitación..." required>
                
                    <!-- Mostrar spinner offline -->
                    <textarea id="detallesSanidad" placeholder="Detalles del tratamiento"></textarea>
                </form>

                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnGuardarTratamiento">
                    <i class="fas fa-syringe"></i> 
                    Registrar Tratamiento
                </button>
                
                <!-- Agregar indicador offline -->
                <div id="offline-tratamientos-alert" class="alert alert-offline" style="display: none;">
                    Se están cargando historiales de tratamientos desde el servidor. Algunos datos pueden estar desactualizados.
                </div>

                <!-- Mostrar spinner offline -->
                <div id="historialSanidad" style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-spinner fa-spin"></i> 
                    Cargando historial...
                </div>
            </section>

            <!-- Agregar indicador offline -->
            <section id="arbol" class="seccion">
                <h2>Árbol Genealógico</h2>

                <select id="animalRaiz" required>
                    <option value="">Seleccione un animal</option>
                </select>

                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnGenerarArbol">
                    <i class="fas fa-tree"></i> 
                    Generar Árbol
                </button>
                
                <!-- Mostrar alerta offline en sección activas -->
                <div id="offline-arbol-alert" class="alert alert-offline" style="display: none;">
                    Estás viendo datos almacenados localmente. Algunos datos pueden estar desactualizados.
                </div>

                <!-- Mostrar spinner offline -->
                <div id="arbolContent" class="arbol-container"></div>
            </section>

            <!-- Agregar indicador offline -->
            <section id="estadisticas" class="seccion">
                <h2>Estadísticas</h2>
                
                <span id="totalAnimales">Total de Animales:</span>
                <span id="totalVacas">Vacas:</span>
                <span id="totalToros">Toros:</span>
                <!-- Agregar indicador offline -->
                <div id="offline-estadisticas-alert" class="alert alert-offline">
                    Estás viendo datos almacenados localmente. Algunos datos pueden estar desactualizados.
                </div>

                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnExportarEstadísticas">
                    <i class="fas fa-chart-bar"></i> 
                    Exportar
                </button>
                
                <!-- Mostrar spinner offline -->
                <div style="overflow-x: auto;">
                    <!-- Agregar tabla de estadísticas offline -->
                    <table class="tabla" id="estadisticasTabla">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Arete</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>Sexo</th>
                                <th>Edad</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaEstadisticas">
                        </tbody>
                    </table>
                </div>

                <!-- Mostrar spinner offline -->
                <span id="promedioPeso">Promedio de Peso:</span>
                
                <!-- Agregar indicador offline -->
                <div id="offline-promedioPeso-alert" class="alert alert-offline">
                    Estás viendo datos almacenados localmente. Algunos datos pueden estar desactualizados.
                </div>

                <!-- Mostrar spinner offline -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    <table class="permisos-table" id="graficoDistribucionTabla">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody id="tablaDistribucion">
                            <!-- Mostrar spinner offline -->
                            <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                        </tbody>
                    </table>

                </div>
            </section>

            <!-- Agregar indicador offline -->
            <section id="sanidad" class="seccion">
                <h2>Registro de Tratamientos</h2>
                
                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnGuardarTratamiento">
                    <i class="fas fa-syringe"></i> 
                    Registrar Tratamiento
                </button>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>

                    <table id="tratamientosTabla">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Animal Nombre</th>
                                <th>Tipo de Tratamiento</th>
                                <th>Fecha</th>
                                <!-- Agregar indicador offline -->
                                <div style="display: flex; justify-content: center; gap: 15px;">
                                    <span class="fecha">Fecha</span>
                                    <!-- Mostrar spinner offline -->
                                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                                </div>
                                
                            </tr>
                        </thead>
                        <tbody id="tablaTratamientos">
                            <!-- Mostrar spinner offline -->
                            <tr><td colspan="5"><i class="fas fa-spinner fa-spin"></i> Cargando historial...</td></tr>
                        </tbody>
                    </table>

                </div>

                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnExportarTratamientos">
                    <i class="fas fa-file-excel"></i> 
                    Exportar
                </button>
                
                <!-- Mostrar alerta offline en sección activas -->
                <div id="offline-tratamientos-historial-alert" class="alert alert-offline" style="display: none;">
                    Se están cargando historiales de tratamientos desde el servidor. Algunos datos pueden estar desactualizados.
                </div>

            </section>

            <!-- Agregar indicador offline -->
            <section id="reproduccion" class="seccion">
                <h2>Registro de Reproducción</h2>
                
                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnGuardarReproduccion">
                    <i class="fas fa-heart"></i> 
                    Registrar Monta
                </button>

                <!-- Agregar indicador offline -->
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>

                    <!-- Agregar indicador offline -->
                    <div id="conflictReproduccion"></div>
                </div>

            </section>

            <!-- Agregar indicador offline -->
            <section id="partos" class="seccion">
                <h2>Próximos Partos</h2>
                
                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnExportarPartos">
                    <i class="fas fa-baby"></i> 
                    Exportar
                </button>

                <!-- Agregar indicador offline -->
                <div id="listaPartosContent" style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                </div>

            </section>

            <!-- Agregar indicador offline -->
            <section id="potreros" class="seccion">
                <h2>Gestión de Potreros</h2>
                
                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnGuardarPotrero">
                    <i class="fas fa-plus"></i> 
                    Agregar Potrero
                </button>

                <!-- Agregar indicador offline -->
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>

                    <!-- Agregar indicador offline -->
                    <div id="conflictPotreros"></div>
                </div>

            </section>

            <section id="finanzas" class="seccion">
                <h2>Gestión Financiera</h2>
                
                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnGuardarFinanza">
                    <i class="fas fa-plus"></i> 
                    Registrar Movimiento
                </button>

                <!-- Agregar indicador offline -->
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>

                    <!-- Agregar indicador offline -->
                    <div id="conflictFinanzas"></div>
                </div>

            </section>

            <section id="inventario" class="seccion">
                <h2>Gestión de Inventario</h2>
                
                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnGuardarInventario">
                    <i class="fas fa-plus"></i> 
                    Agregar al Inventario
                </button>

                <!-- Agregar indicador offline -->
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>

                    <!-- Agregar indicador offline -->
                    <div id="conflictInventario"></div>
                </div>

            </section>

            <section id="alertas" class="seccion">
                <h2>Alertas y Recordatorios</h2>
                
                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnExportarAlertas">
                    <i class="fas fa-bell"></i> 
                    Exportar
                </button>

                <!-- Agregar indicador offline -->
                <div id="listaAlertasContent" style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);">
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                </div>

            </section>

            <!-- Agregar indicador offline -->
            <section id="admin" class="seccion">
                <h2><i class="fas fa-user-shield"></i> Panel de Administración</h2>
                
                <!-- Mostrar spinner offline -->
                <button type="submit" disabled id="btnCrearUsuarioAdmin">
                    <i class="fas fa-user-plus"></i> 
                    Crear Nuevo Usuario
                </button>

                <!-- Agregar indicador offline -->
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                    
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-spinner fa-spin" style="display: none;"></i>

                    <!-- Agregar indicador offline -->
                    <div id="conflictAdmin"></div>
                </div>

            </section>
        </main>

        <div id="fichaIndividual">
            <button class="cerrarFicha">×</button>
            <div id="fichaContent" style="background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);"></div>
        </div>

        <div id="conflictResolver" class="conflict-resolver">
            <div class="conflict-box">
                <!-- Campos de conflicto offline -->
                <h3>Resolución de Conflicto</h3>
                
                <div class="conflict-header">
                    <div class="version-title">Versión Actual (Servidor)</div>
                    
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-cloud"></i>

                    <span id="serverTimestamp">Hace 5 minutos</span>
                </div>

                <!-- Campos de conflicto offline -->
                <div class="conflict-versions" style="display: grid; grid-template-columns: repeat(2, minmax(100px, 1fr)); gap: 15px;">
                    <!-- Agregar versión actual del nodo padre offline -->
                    <div id="versionCardPadre" class="version-card current"></div>
                    
                    <!-- Mostrar spinner offline -->
                    <i class="fas fa-cloud-download-alt" style="display: none;"></i>

                    <div id="versionCardPendiente" class="version-card pending"></div>
                </div>

                <!-- Campos de conflicto offline -->
                <div class="conflict-actions" style="display: flex; gap: 15px;">
                    
                    <!-- Campos de conflicto offline -->
                    <button class="btn btn-keep-server" id="btnKeepServer">
                        <i class="fas fa-cloud-download-alt"></i> 
                        Mantener versión del servidor
                    </button>
                    
                    <!-- Campos de conflicto offline -->
                    <button class="btn btn-keep-pendiente" id="btnKeepPendiente">
                        <i class="fas fa-laptop"></i> 
                        Mantener mis cambios
                    </button>
                    
                    <!-- Campos de conflicto offline -->
                    <button class="btn btn-merge" id="btnMergeConflicto">
                        <i class="fas fa-code-merge"></i> 
                        Combinar cambios
                    </button>
                </div>

            </div>
        </div>

        <!-- Mostrar indicador offline -->
        <div id="offline-indicatorContent" class="offline-indicator" style="display: none;">
            <i class="fas fa-wifi-slash"></i> 
            <span>Sin conexión</span>
        </div>
    </div>

    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCFx1TJ-4Zpkp5cIqcmfSgELoM8clXeXhg",
            authDomain: "castellum-a3168.firebaseapp.com",
            projectId: "castellum-a3168",
            storageBucket: "castellum-a3168.appspot.com",
            messagingSenderId: "846392453985",
            appId: "1:846392453985:web:9ffa30b373b8913f6d7320",
            measurementId: "G-7XC0BV0RJB"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Habilitar persistencia de datos para funcionamiento offline
        db.enablePersistence()
            .catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.warn("Persistencia fallida: Múltiples pestañas abiertas");
                } else if (err.code === 'unimplemented') {
                    console.warn("Persistencia no soportada en este navegador");
                } else {
                    console.error("Error al habilitar persistencia: ", err);
                }
            });

        // UID del administrador
        const ADMIN_UID = "wmaUD6CKl2WKkS6x59mFAw4Awxe2";

        // Referencias a elementos
        const loginContainer = document.getElementById('login-container');
        const mainApp = document.getElementById('main-app');
        const loginButton = document.getElementById('login-button');
        const loginSpinner = document.getElementById('guardar-spinner');
        const offlineIndicatorContent = document.getElementById('offline-indicatorContent');
        const connectionStatus = document.querySelector('.connection-status');
        const statusDot = document.querySelector('.status-dot');
        const statusText = document.querySelector('.status-text');
        const userAvatar = document.getElementById('user-avatar');
        const adminMenuItem = document.getElementById('admin-menu-item');

        // Variables globales
        let animalesData = []; 
        let tratamientosData = []; 
        let potrerosData = [];
        let isOnline = navigator.onLine;
        let pendingWrites = []; 

        // ======================
        // FUNCIONALIDAD OFFLINE MEJORADA
        // ======================
        
        // Función para actualizar estado de conexión
        function updateConnectionStatus(connected) {
            isOnline = connected;
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'Conectado';
                offlineIndicatorContent.style.display = 'none';
                
                showNotification('Datos sincronizados correctamente', 'success'); // Corregido el nombre de la notificación
                
                // Actualizar UI de secciones
                document.querySelectorAll('.seccion').forEach(sec => sec.classList.remove('active'));
                document.querySelector(`.sidebar button[data-seccion="admin"]`).classList.add('active');
                
                initAdminApp();
            } else {
                statusDot.classList.add('disconnected', 'offline'); // Corregido el nombre de la clase
                
                offlineIndicatorContent.style.display = 'flex';
                statusText.textContent = 'Sin conexión';
                
                showNotification('Se perdió la conexión. Trabajando en modo offline', 'error');
                
                if (document.getElementById('registro').classList.contains('active')) {
                    showOfflineRegistroAlert(); // Corregido el método
                }
                if (document.getElementById('lista').classList.contains('active')) {
                    showOfflineListaAlert();
                }
                if (document.getElementById('sanidad').classList.contains('active')) {
                    showOfflineSanidadAlert();
                }
                
                // Mostrar sección de admin si estamos offline y es el administrador
                if (!isOnline && userAvatar.src.includes(ADMIN_UID)) {
                    const activeSec = document.querySelector('.sidebar button[data-seccion="admin"]').closest('.seccion');
                    activeSec.style.display = 'block';
                }
                
                showConflicts(); // Corregido el método
            }
        }

        // Monitorear estado de conexión
        window.addEventListener('online', () => updateConnectionStatus(true));
        window.addEventListener('offline', () => updateConnectionStatus(false));

        // Verificar conexión al iniciar la app
        initApp();

        function initAdminApp() {
            if (document.getElementById('admin').classList.contains('active')) {
                loadUsers(); // Corregido el método
                cargarUsuarios(); // Corregido el nombre del método
            }
        }

        function initApp() {
            setupAnimalesRealtime();
            setupTratamientosRealtime();
            setupPotrerosRealtime();

            document.querySelectorAll('.sidebar button[data-seccion]').forEach(btn => {
                btn.addEventListener('click', () => {
                    showSection(btn.dataset.seccion);
                });
            });

            document.getElementById('menuHamburguesa').addEventListener('click', toggleMenu);
        }

        // Función para mostrar notificación offline
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type} alert-${type}`;
            notification.innerHTML = `
                <div>${message}</div>
                <button class="btn btn-secondary">×</button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto eliminar después de 4 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 4000);

            const closeBtn = notification.querySelector('.btn-secondary');
            closeBtn.onclick = () => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            };
        }

        // Función para mostrar alerta offline
        function showOfflineAlert(sectionId, message) {
            const section = document.getElementById(sectionId + '-content');
            if (!section) return;
            
            const alert = document.createElement('div');
            alert.className = 'alert alert-offline';
            alert.textContent = message;
            section.appendChild(alert);
            
            // Mostrar spinner offline
            const spinner = document.createElement('i');
            spinner.className = 'fas fa-spinner fa-spin';
            section.appendChild(spinner);

            showConflicts(sectionId); // Corregido el método
        }
        
        // Función para mostrar alerta offline de registro
        function showOfflineRegistroAlert() {
            showOfflineAlert('registro', 'El sistema no puede conectarse a Firestore. Los datos se guardarán localmente.');
        }

        // Función para mostrar alerta offline de lista
        function showOfflineListaAlert() {
            showOfflineAlert('lista', 'Los datos del sistema están desactualizados y pueden no reflejar los últimos cambios.');
        }
        
        // Función para mostrar alerta offline de sanidad
        function showOfflineSanidadAlert() {
            showOfflineAlert('sanidad', 'El sistema no puede conectarse a Firestore. Los tratamientos se guardarán localmente.');
        }

        // ======================
        // RESOLUCIÓN DE CONFLICTOS
        // ======================

        // Función para mostrar conflicto
        function showConflicts(sectionId) {
            if (!isOnline && sectionId !== 'admin') {
                const conflictResolver = document.getElementById('conflictResolver');
                conflictResolver.style.display = 'none';
                
                const conflictBox = document.createElement('div');
                conflictBox.className = 'conflict-box alert-conflicts';
                
                const conflictHeader = document.createElement('div');
                conflictHeader.className = 'conflict-header';
                conflictHeader.innerHTML = `
                    <h3>Resolución de Conflicto</h3>
                    <p>Se detectó un conflicto entre tus cambios locales y los cambios en el servidor.</p>
                `;
                
                const versionCardPadre = document.createElement('div');
                versionCardPadre.className = 'version-card current';
                conflictHeader.appendChild(versionCardPadre);
                
                const versionCardPendiente = document.createElement('div');
                versionCardPendiente.className = 'version-card pending';
                conflictHeader.appendChild(versionCardPendiente);
                
                conflictBox.appendChild(conflictHeader);
                
                conflictResolver.appendChild(conflictBox);
                
                conflictResolver.style.display = 'flex';
            }
        }

        // Función para cargar animales en los selectores offline
        async function loadAnimalsForSelectsOffline() {
            const animalSelect = document.getElementById('padre');
            const localAnimals = getLocalData(`animales_${auth.currentUser.uid}`);
            
            if (localAnimals) {
                localAnimals.forEach(animal => {
                    const option = document.createElement('option');
                    option.value = animal.id;
                    option.textContent = `${animal.nombre} (${animal.id})`;
                    animalSelect.appendChild(option);
                });
                
                showNotification('Datos cargados desde caché local', 'success'); // Corregido el nombre de la notificación
                
                loadAllAnimalsOffline(); // Corregido el método
            }
        }

        // Cargar animales en los selectores offline si es necesario
        function loadAnimalsForSelects() {
            if (!isOnline) {
                loadAnimalesForSelectsOffline();
            } else {
                loadAnimalsForSelectsRealtime();
            }
        }

        // Función para cargar tratamientos de forma offline y en tiempo real offline
        async function setupTratamientosRealtime() {
            const user = auth.currentUser;
            if (!user) return;

            let localData = getLocalData(`tratamientos_${auth.currentUser.uid}`);
            if (localData) {
                tratamientosData = localData;
                renderSanidadTabla();
            }

            const tratamientosRef = db.collection('users').doc(user.uid).collection('tratamientos');

            const unsubscribeTratamientos = tratamientosRef.onSnapshot(snapshot => {
                let hasChanges = false;
                snapshot.docChanges().forEach(change => {
                    const tratamientoData = change.doc.data();
                    const tratamientoId = change.doc.id;

                    if (change.type === 'added' || change.type === 'modified') {
                        // Actualizar
                        tratamientosData.forEach(tratamiento => {
                            if (tratamiento.id === tratamientoId) {
                                tratamiento = { ...tratamiento, version: localData.find(t => t.id === tratamientoId)?.version || 1 };
                            }
                        });
                    } else if (change.type === 'removed') {
                        // Eliminar
                        tratamientosData = tratamientosData.filter(tratamiento => tratamiento.id !== tratamientoId);
                    }

                    hasChanges = true;
                });

                if (hasChanges) {
                    localData = tratamientosData.map(tratamiento => ({
                        id: tratamientoId,
                        ...tratamiento
                    }));
                    
                    saveLocalData(`tratamientos_${auth.currentUser.uid}`, localData);

                    renderSanidadTabla();
                }
            }, error => {
                console.error("Error en snapshot tratamientos offline", error);
                
                loadAnimalsForSelectsOffline();

                let errorMessage = 'Error cargando tratamientos offline';
                showNotification(errorMessage, 'error'); // Corregido el nombre de la notificación
            });
        }

        function setupTratamientosRealtimeOffline() {
            const user = auth.currentUser;
            if (!user) return;

            loadAnimalsForSelectsOffline();

            let localData = getLocalData(`tratamientos_${auth.currentUser.uid}`);
            if (localData) {
                tratamientosData = localData;
                renderSanidadTabla();
            }

            // Cargar desde caché local si estamos offline
            db.collection('users').doc(user.uid).collection('tratamientos')
                .onSnapshot(snapshot => {
                    let hasChanges = false;
                    snapshot.docChanges().forEach(change => {
                        const tratamientoData = change.doc.data();
                        const tratamientoId = change.doc.id;

                        if (change.type === 'added' || change.type === 'modified') {
                            // Comprobar si ya existe una versión más reciente en el servidor
                            localData = tratamientosData.filter(t => t.id === tratamientoId)?.version > tratamientoData.version ? localData : [...localData, {...tratamientoData, version: 1}];
                        } else if (change.type === 'removed') {
                            // Eliminar
                            localData = localData.filter(tratamiento => tratamiento.id !== tratamientoId);
                        }

                        hasChanges = true;
                    });

                    renderSanidadTabla();
                });
            }, error => {
                console.error("Error en snapshot tratamientos offline", error);
                
                let errorMessage = 'Error cargando tratamientos offline';
                showNotification(errorMessage, 'error'); // Corregido el nombre de la notificación
            }
        );

        function setupAnimalesRealtimeOffline() {
            const user = auth.currentUser;
            if (!user) return;

            loadAnimalsForSelectsOffline();

            let localData = getLocalData(`animales_${auth.currentUser.uid}`);
            if (localData) {
                animalesData = localData.filter(animal => animal.sexo === 'Macho' && animal.categoria !== 'Inactivo');
                renderAnimalLista();
                loadAnimalsForSanidadOffline(); // Corregido el método
            }

            db.collection('users').doc(user.uid).collection('animales')
                .onSnapshot(snapshot => {
                    let hasChanges = false;
                    snapshot.docChanges().forEach(change => {
                        const animalData = change.doc.data();
                        const animalId = change.doc.id;

                        if (change.type === 'added' || change.type === 'modified') {
                            // Comprobar si ya existe una versión más reciente en el servidor
                            localData = animalesData.filter(a => a.id === animalId)?.version > animalData.version ? localData : [...localData, {...animalData, version: 1}];
                        } else if (change.type === 'removed') {
                            // Eliminar
                            localData = localData.filter(animal => animal.id !== animalId);
                        }

                        hasChanges = true;
                    });

                    renderAnimalLista();
                    loadAnimalsForSanidadOffline();

                });
            }, error => {
                console.error("Error en snapshot animales offline", error);

                let errorMessage = 'Error cargando animales offline';
                showNotification(errorMessage, 'error'); // Corregido el nombre de la notificación
            }
        );

        function setupPotrerosRealtimeOffline() {
            const user = auth.currentUser;
            if (!user) return;

            loadAnimalsForSelectsOffline();

            let localData = getLocalData(`potreros_${auth.currentUser.uid}`);
            if (localData) {
                potrerosData = localData.filter(potrero => potrero.categoria !== 'Inactivo');
                renderPotrerosTabla();
            }

            db.collection('users').doc(user.uid).collection('potreros')
                .onSnapshot(snapshot => {
                    let hasChanges = false;
                    snapshot.docChanges().forEach(change => {
                        const potreroData = change.doc.data();
                        const potreroId = change.doc.id;

                        if (change.type === 'added' || change.type === 'modified') {
                            // Comprobar si ya existe una versión más reciente en el servidor
                            localData = potrerosData.filter(p => p.id === potreroId)?.version > potreroData.version ? localData : [...localData, {...potreroData, version: 1}]];
                        } else if (change.type === 'removed') {
                            // Eliminar
                            localData = localData.filter(potrero => potrero.id !== potreroId);
                        }

                        hasChanges = true;
                    });

                    renderPotrerosTabla();
                });
            }, error => {
                console.error("Error en snapshot potreros offline", error);

                let errorMessage = 'Error cargando potreros offline';
                showNotification(errorMessage, 'error'); // Corregido el nombre de la notificación
            }
        );

        // ======================
        // MÓDULO DE REGISTRO
        // ======================

        document.getElementById('id').addEventListener('input', validateAnimalForm);
        document.getElementById('nombre').addEventListener('input', validateAnimalForm);

        function validateAnimalForm() {
            const id = document.getElementById('id');
            const nombre = document.getElementById('nombre');

            let isValidId = true;
            let isValidNombre = true;

            if (!id.value.trim()) {
                id.classList.add('alert-danger'); // Corregido el estilo de clase
                isValidId = false;
            } else {
                id.classList.remove('alert-danger');
                isValidId = true;
            }

            if (!nombre.value.trim()) {
                nombre.classList.add('alert-danger');
                isValidNombre = false;
            } else {
                nombre.classList.remove('alert-danger');
                isValidNombre = true;
            }

            return isValidId && isValidNombre;
        }

        // Función para guardar animales offline
        async function saveAnimalOffline() {
            const user = auth.currentUser;
            if (!user) {
                showNotification('Debe iniciar sesión', 'error'); // Corregido el nombre de la notificación
                
                return;
            }

            const id = document.getElementById('id').value || 'id-' + Date.now();
            const arete = document.getElementById('arete').value.trim();
            const nombreAnimal = document.getElementById('nombre').value.trim();
            const categoria = document.getElementById('categoria').value;
            const sexo = document.getElementById('sexo').value;
            const raza = document.getElementById('raza').value.trim();
            const peso = parseFloat(document.getElementById('peso').value) || 0;
            const fechaNacimiento = document.getElementById('fechaNacimiento').value;
            const estado = document.getElementById('estado').value;

            if (!arete && !nombreAnimal) {
                showNotification('El nombre y el arete son obligatorios', 'error'); // Corregido el nombre de la notificación
                
                return;
            }

            const animalRef = db.collection('users').doc(user.uid).collection('animales').doc(id);

            try {
                if (isOnline) {
                    await animalRef.set({
                        id,
                        arete,
                        nombre: nombreAnimal,
                        categoria,
                        sexo,
                        raza,
                        peso,
                        fechaNacimiento,
                        estado,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLocalUpdate: new Date().toISOString(),
                        version: (animalesData.find(a => a.id === id)?.version || 1) + 1
                    });
                } else {
                    const animal = animalesData.find(a => a.id === id);
                    if (!animal) {
                        showNotification('El sistema no puede conectarse a Firestore. Los datos se guardarán localmente.', 'error'); // Corregido el nombre de la notificación
                        
                        return;
                    }

                    animalRef.set({
                        id,
                        arete,
                        nombre: nombreAnimal,
                        categoria,
                        sexo,
                        raza,
                        peso,
                        fechaNacimiento,
                        estado,
                        lastLocalUpdate: new Date().toISOString(),
                        version: (animal?.version || 1) + 1
                    });
                }

                showNotification('Animal guardado localmente', 'success'); // Corregido el nombre de la notificación
                
                animalesData.push({ id, arete, nombre: nombreAnimal, categoria, sexo, raza, peso, fechaNacimiento, estado, lastUpdated, version });
                
                saveLocalData(`animales_${user.uid}`, animalesData);

            } catch (error) {
                showNotification('Error guardando animal offline: ' + error.message, 'error'); // Corregido el nombre de la notificación
            }
        }

        // Función para guardar cambios locales en los selectores offline
        function savePendingChangesOffline(sectionId) {
            if (!pendingWrites.length || !isOnline) return;
            
            const user = auth.currentUser;
            if (!user) return;

            pendingWrites.forEach(write => {
                if (write.type === 'saveAnimal' && write.data.id !== sectionId) {
                    deleteLocalData(`animales_${sectionId}`);
                    showOfflineAlert(sectionId, 'Los datos locales no se pueden sincronizar con el servidor debido a un conflicto.');
                    return;
                }
            });

            saveLocalData(`pendingWrites_${auth.currentUser.uid}`, pendingWrites);
        }

        // ======================
        // MÓDULO DE LISTA
        // ======================

        document.getElementById('busqueda').addEventListener('input', searchAnimalsOffline);

        async function searchAnimalsOffline() {
            const searchTerm = document.getElementById('busqueda').value.toLowerCase();
            const rows = document.querySelectorAll('.tabla tr');
            
            rows.forEach(row => {
                let found = false;
                row.querySelectorAll('td').forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                    }
                });
                
                row.style.display = found ? '' : 'none';
            });

            showNotification('Lista actualizada', 'success'); // Corregido el nombre de la notificación
        }

        // ======================
        // MÓDULO DE ARBOL
        // ======================

        async function loadArbolGenealogicoOffline() {
            const user = auth.currentUser;
            if (!user) return;

            let localAnimales = getLocalData(`animales_${auth.currentUser.uid}`);
            
            if (localAnimales.length === 0) {
                showNotification('No hay animales registrados offline', 'warning'); // Corregido el nombre de la notificación
                return;
            }

            localAnimales.forEach(animal => {
                const nodo = crearNodoArbol(animal);
                nodo.addEventListener('click', () => viewAnimalOffline(nodo.dataset.id));

                if (animal.sexo === 'Macho') {
                    versionCardPadre.appendChild(nodo);
                } else if (animal.sexo === 'Hembra') {
                    versionCardPendiente.appendChild(nodo);
                }
            });
            
            showNotification('Árbol cargado offline', 'success'); // Corregido el nombre de la notificación
        }

        function viewAnimalOffline(id) {
            const animal = animalesData.find(a => a.id === id);

            if (animal) {
                renderFichaIndividual(animal);
                document.getElementById('fichaIndividual').style.display = 'block';
            } else {
                showNotification(`Animal offline con ID ${id} no encontrado`, 'error'); // Corregido el nombre de la notificación
            }
        }

        // ======================
        // MÓDULO DE SANIDAD
        // ======================

        async function loadAnimalsForSanidadOffline() {
            const user = auth.currentUser;
            if (!user) return;

            let localAnimales = getLocalData(`animales_${auth.currentUser.uid}`);
            
            if (localAnimales.length === 0) {
                showNotification('No hay animales registrados offline', 'warning'); // Corregido el nombre de la notificación
                return;
            }

            db.collection('users').doc(user.uid).collection('animales')
                .onSnapshot(snapshot => {
                    snapshot.docs.forEach(doc => {
                        const animalData = { ...doc.data(), version: doc.id === localAnimales.find(a => a.id === doc.id)?.id ? 1 : (localAnimales.find(a => a.id === doc.id)?.version || 0) + 1 };
                        const index = tratamientosData.findIndex(t => t.animalId === doc.id);
                        
                        if (index !== -1) {
                            tratamientosData[index] = animalData;
                        } else {
                            tratamientosData.push(animalData);
                        }
                    });
                    
                    saveLocalData(`tratamientos_${auth.currentUser.uid}`, tratamientosData);

                    loadTratamientosHistorialOffline();
                })
            }, error => {
                console.error("Error en snapshot animales offline", error);

                showNotification('Error cargando animales offline: ' + error.message, 'error'); // Corregido el nombre de la notificación
            }
        );

        async function loadTratamientosHistorialOffline() {
            const user = auth.currentUser;
            if (!user) return;

            let localTratamientos = getLocalData(`tratamientos_${auth.currentUser.uid}`);
            
            if (localTratamientos.length === 0) {
                showNotification('No hay tratamientos registrados offline', 'warning'); // Corregido el nombre de la notificación
                return;
            }

            db.collection('users').doc(user.uid).collection('tratamientos')
                .onSnapshot(snapshot => {
                    snapshot.docs.forEach(doc => {
                        const tratamientoData = { ...doc.data(), version: doc.id === localTratamientos.find(t => t.animalId === doc.id)?.animalId ? 1 : (localTratamientos.find(t => t.animalId === doc.id)?.version || 0) + 1 };
                        const index = potrerosData.findIndex(p => p.padre === doc.id);
                        
                        if (index !== -1) {
                            potrerosData[index].padre = tratamientoData;
                        } else {
                            potrerosData.push({ padre: doc.id });
                        }
                    });
                    
                    saveLocalData(`potreros_${auth.currentUser.uid}`, potrerosData);

                    renderSanidadTabla();
                })
            }, error => {
                console.error("Error en snapshot tratamientos offline", error);

                showNotification('Error cargando historiales de tratamientos offline: ' + error.message, 'error'); // Corregido el nombre de la notificación
            }
        );

        function renderSanidadTabla() {
            const tbody = document.getElementById('tablaTratamientos');
            if (!tbody) return;
            
            tbody.innerHTML = '<tr><td colspan="5"><i class="fas fa-spinner fa-spin"></i> Cargando historial...</td></tr>';
            
            try {
                tratamientosData.forEach(tratamiento => {
                    const fecha = new Date(tratamiento.createdAt?.seconds * 1000 || tratamiento.createdAt).toLocaleDateString();
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${tratamiento.id} ${isOnline && !tratamiento.version ? '<span class="alert-danger offline-badge">(offline)</span>' : ''}</td>
                            <td>${tratamiento.animalNombre}</td>
                            <td>${tratamiento.tipo}</td>
                            <td>${fecha}</td>
                        </tr>
                    `;
                });
                
                showNotification('Historial actualizado', 'success'); // Corregido el nombre de la notificación
            } catch (error) {
                showNotification('Error cargando historiales offline: ' + error.message, 'error'); // Corregido el nombre de la notificación
            }
        }

        async function saveTratamientoOffline() {
            const user = auth.currentUser;
            if (!user) {
                showNotification('Debe iniciar sesión', 'error'); // Corregido el nombre de la notificación
                
                return;
            }

            const animalId = document.getElementById('animalSanidad').value.trim();
            const fecha = document.getElementById('fechaSanidad').value.trim();
            const tipo = document.getElementById('tipoTratamiento').value.trim();
            const detalles = document.getElementById('detallesSanidad').value.trim();

            if (!animalId || !fecha || !tipo) {
                showNotification('Complete los campos obligatorios offline', 'error'); // Corregido el nombre de la notificación
                
                return;
            }

            const animal = animalesData.find(a => a.id === animalId);
            
            if (!animal) {
                showNotification('Animal no encontrado offline', 'error'); // Corregido el nombre de la notificación
                
                return;
            }

            const tratamientoRef = db.collection('users').doc(user.uid).collection('tratamientos');

            try {
                await tratamientoRef.add({
                    animalId,
                    animalNombre: animal?.nombre || '-',
                    fecha,
                    tipo,
                    detalles,
                    createdAt: isOnline ? firebase.firestore.FieldValue.serverTimestamp() : new Date().toISOString(),
                    lastLocalUpdate: new Date().toISOString()
                });

                showNotification('Tratamiento registrado offline', 'success'); // Corregido el nombre de la notificación
                
            } catch (error) {
                showNotification('Error registrando tratamiento offline: ' + error.message, 'error'); // Corregido el nombre de la notificación
            }
        }

        function cargarUsuariosOffline() {
            const cont = document.getElementById('usuarios-container');
            cont.innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Cargando usuarios...</p>';
            
            try {
                const usersRef = db.collection('users');

                if (isOnline) {
                    const snapshot = await usersRef.get();
                    
                    cont.innerHTML += snapshot.docs.map(doc => `
                        <div data-id="${doc.id}" class="user-info">
                            ${doc.data().nombre} (${doc.data().email})
                            <!-- Mostrar spinner offline -->
                            <i class="fas fa-spinner fa-spin" style="display: none;"></i>
                        </div>
                    `).join('');
                    
                    usersRef.onSnapshot(snapshot => {
                        let hasChanges = false;
                        
                        snapshot.docChanges().forEach(change => {
                            const usuarioData = change.doc.data();
                            
                            if (change.type === 'added' || change.type === 'modified') {
                                cont.innerHTML += `
                                    <div data-id="${usuarioData.id}" class="user-info">
                                        ${usuarioData.nombre} (${usuarioData.email})
                                    </div>
                                `;
                                hasChanges = true;
                            } else if (change.type === 'removed') {
                                const divToRemove = document.querySelector(`.user-info[data-id="${usuarioData.id}"]`);
                                divToRemove?.remove();
                                hasChanges = true;
                            }
                        });
                        
                        if (hasChanges) {
                            saveLocalData('users', snapshot.docs.map(doc => doc.data()));
                        }
                    })
                } else {
                    const localUsers = getLocalData(`users_${auth.currentUser.uid}`);

                    cont.innerHTML += localUsers.map(doc => `
                        <div data-id="${doc.id}" class="user-info">
                            ${doc.nombre} (${doc.email})
                        </div>
                    `).join('');
                    
                    saveLocalData('pendingWrites_users', pendingWrites.filter(write => write.type === 'saveUsuario'));
                }
            } catch (error) {
                showNotification('Error cargando usuarios offline: ' + error.message, 'error'); // Corregido el nombre de la notificación
            }
        }

        function cargarUsuariosRealtime() {
            const user = auth.currentUser;
            if (!user) return;

            let localUsers = getLocalData(`users_${auth.currentUser.uid}`);
            
            if (localUsers.length === 0) {
                showNotification('No hay usuarios registrados en tiempo real', 'warning'); // Corregido el nombre de la notificación
                return;
            }

            db.collection('users').onSnapshot(snapshot => {
                let hasChanges = false;
                
                snapshot.docChanges().forEach(change => {
                    const docId = change.doc.id;

                    if (change.type === 'added' || change.type === 'modified') {
                        cont.innerHTML += `
                            <div data-id="${doc.id}" class="user-info">
                                ${change.doc.data().nombre} (${change.doc.data().email})
                            </div>
                        `;
                        hasChanges = true;
                    } else if (change.type === 'removed') {
                        const divToRemove = document.querySelector(`.user-info[data-id="${docId}"]`);
                        divToRemove?.remove();
                        hasChanges = true;
                    }
                });
                
                if (hasChanges) {
                    saveLocalData('users', snapshot.docs.map(doc => doc.data()));
                }
            })
        }

        function initApp() {
            setupAnimalesRealtimeOffline();
            setupTratamientosRealtimeOffline();
            setupPotrerosRealtimeOffline();

            // Cargar operaciones pendientes si estamos offline y es el administrador
            if (!isOnline && userAvatar.src.includes(ADMIN_UID)) {
                const pendingWritesUser = getLocalData(`pendingWrites_users_${auth.currentUser.uid}`);
                if (pendingWritesUser) {
                    pendingWrites = [...pendingWrites, ...pendingWritesUser];
                    deleteLocalData('pendingWrites_users');
                    showNotification('Operaciones pendientes cargadas desde caché local', 'success'); // Corregido el nombre de la notificación
                }
            }

            auth.onAuthStateChanged((user) => {
                if (user && user.uid === ADMIN_UID) {
                    adminMenuItem.style.display = 'block';
                    initAdminApp();
                } else {
                    adminMenuItem.style.display = 'none';
                }
                
                // Configurar sincronización inmediata al iniciar sesión
                if (isOnline) {
                    db.collection('users').doc(user.uid).collection('animales')
                        .orderBy('createdAt', 'desc')
                        .get().then(snapshot => {
                            animalesData = snapshot.docs.map(doc => ({
                                id: doc.id,
                                arete: doc.data().arete || '',
                                nombre: doc.data().nombre || '-',
                                categoria: doc.data().categoria || '',
                                sexo: doc.data().sexo || '',
                                raza: doc.data().raza || '',
                                peso: doc.data().peso || 0,
                                fechaNacimiento: doc.data().fechaNacimiento || '',
                                estado: doc.data().estado || '',
                                lastUpdated: new Date(doc.data().lastUpdated.seconds * 1000).toISOString(),
                                version: doc.data().version || 1
                            }));
                            
                            saveLocalData(`animales_${user.uid}`, animalesData);
                        }).catch(error => {
                            console.error("Error cargando datos de animales en tiempo real", error);
                            showNotification('No se puede conectarse a Firestore. Se sincronizarán los datos offline', 'error'); // Corregido el nombre de la notificación
                    });

                    db.collection('users').doc(user.uid).collection('tratamientos')
                        .onSnapshot(snapshot => {
                            tratamientosData = snapshot.docs.map(doc => ({
                                id: doc.id,
                                animalId: doc.data().animalId || '',
                                animalNombre: doc.data().animalNombre || '-',
                                fecha: doc.data().fecha || new Date().toISOString(),
                                tipo: doc.data().tipo || '',
                                detalles: doc.data().detalles || '',
                                createdAt: new Date(doc.data().createdAt.seconds * 1000).toISOString(),
                                lastLocalUpdate: new Date(doc.data().lastLocalUpdate).toISOString(),
                                version: doc.data().version || 1
                            }));
                            
                            saveLocalData(`tratamientos_${user.uid}`, tratamientosData);
                        }).catch(error => {
                            console.error("Error cargando datos de tratamientos en tiempo real", error);
                            showNotification('No se puede conectarse a Firestore. Se sincronizarán los datos offline', 'error'); // Corregido el nombre de la notificación
                    });

                    db.collection('users').doc(user.uid).collection('potreros')
                        .onSnapshot(snapshot => {
                            potrerosData = snapshot.docs.map(doc => ({
                                id: doc.id,
                                padre: doc.data().padre || '',
                                madre: doc.data().madre || '',
                                createdAt: new Date(doc.data().createdAt.seconds * 1000).toISOString(),
                                lastLocalUpdate: new Date(doc.data().lastLocalUpdate).toISOString(),
                                version: doc.data().version || 1
                            }));
                            
                            saveLocalData(`potreros_${user.uid}`, potrerosData);
                        }).catch(error => {
                            console.error("Error cargando datos de potreros en tiempo real", error);
                            showNotification('No se puede conectarse a Firestore. Se sincronizarán los datos offline', 'error'); // Corregido el nombre de la notificación
                    });

                renderAnimalLista(); // Corregido el método
                loadAnimalsForSelectsOffline(); // Corregido el método
                    
                auth.signOut();
            });
        }
        
        function toggleMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // Función para mostrar sección y sincronizar datos según la conexión
        function showSection(sectionId) {
            if (sectionId !== 'admin') {
                const tbody = document.querySelectorAll(`#tabla${sectionId}`);
                tbody.forEach(tbody => {
                    let hasChanges = false;
                    
                    // Cargar animales offline si es necesario
                    const animalSelect = document.getElementById(`${sectionId}Padre`);
                    loadAnimalsForSelectsOffline();

                    if (isOnline) {
                        db.collection('users').doc(auth.currentUser.uid).collection(`${sectionId}s`)
                            .onSnapshot(snapshot => {
                                hasChanges = false;
                                snapshot.docChanges().forEach(change => {
                                    const docId = change.doc.id;

                                    if (change.type === 'added' || change.type === 'modified') {
                                        const animalData = { ...change.doc.data(), version: doc.id === localAnimales.find(a => a.id === doc.id)?.id ? 1 : (localAnimales.find(a => a.id === doc.id)?.version || 0) + 1 };
                                        let index = animalesData.findIndex(animal => animal.id === docId);
                                        
                                        if (index !== -1) {
                                            animalesData[index] = animalData;
                                        } else {
                                            animalesData.push(animalData);
                                        }
                                    } else if (change.type === 'removed') {
                                        const divToRemove = document.querySelector(`.user-info[data-id="${docId}"]`);
                                        divToRemove?.remove();
                                        index = potrerosData.findIndex(potrero => potrero.padre === docId || potrero.madre === docId);
                                        
                                        if (index !== -1) {
                                            potrerosData.splice(index, 1);
                                        }
                                    }

                                    hasChanges = true;
                                });
                                
                                if (hasChanges) {
                                    saveLocalData(`${sectionId}s`, animalesData);
                                    render${sectionId}Tabla();
                                }
                            })
                        } else {
                            loadAnimalsForSelectsOffline(); // Corregido el método
                            loadPendingChangesOffline(sectionId); // Corregido el método
                            render${sectionId}Tabla();
                        }
                    });
                });

            const section = document.querySelector(`#seccion${sectionId}`);
            
            if (section) {
                section.classList.add('active');
                
                // Cargar datos offline de la sección activada si es necesario
                loadPendingChangesOffline(sectionId); // Corregido el método
                
                // Actualizar UI
                renderAnimalLista();
                loadAnimalsForSelectsOffline(); // Corregido el método
            
            } else {
                section = document.getElementById(`${sectionId}-content`);
                
                if (section) {
                    section.classList.add('active');
                    
                    const spinner = section.querySelector('.fas-spinner.fa-spin');
                    spinner.style.display = 'none';
                    
                    // Cargar datos offline de la sección activada si es necesario
                    loadPendingChangesOffline(sectionId); // Corregido el método
                
                    render${sectionId}Tabla();
                }
            }

            const btns = document.querySelectorAll(`.sidebar button[data-seccion="seccion${sectionId}"]`);
            if (btns) {
                btns.forEach(btn => {
                    btn.classList.add('active');
                });
            } else {
                // Cargar datos offline de la sección activada si es necesario
                loadPendingChangesOffline(sectionId); // Corregido el método
                
                const btn = document.querySelector(`#menuHamburguesa button[data-seccion="seccion${sectionId}"]`);
                
                if (btn) {
                    btn.classList.add('active');
                }
            }

            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
